% VS code setting
% Ctrl + Alt + B -> Build
% Ctrl + Alt + V -> Preview PDF file

\documentclass[9pt, a4paper]{extarticle}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{bcprules, proof}
\usepackage{fancybox}
\usepackage{mathtools}
\usepackage{float}
\usepackage[truedimen,margin=15truemm]{geometry}
\usepackage{color}
\usepackage{xparse}
\usepackage{ebproof}
\usepackage{lscape}
\usepackage{mdframed}

% \theoremstyle{definition}
% \newtheoremstyle{break}
%   {\topsep}{\topsep}%
%   {\itshape}{}%
%   {\bfseries}{}%
%   {\newline}{}%

\newtheoremstyle{break}
  {\topsep}{\topsep}%
  {}{}%
  {\bfseries}{}%
  {\newline}{}%
\theoremstyle{break}
% \newtheorem{thm}{Theorem}
\newmdtheoremenv{thm}{Theorem}
\newmdtheoremenv{dfn}{Defnition}
\newtheorem{ex}{Example}
\newtheorem{cm}{Comment}

\newif\iffullversion
\fullversionfalse

\newcommand{\rulefbox}[1]{\fbox{\ensuremath{#1}} \hspace{1mm}}

\newcommand{\figheader}[2]{
  \begin{flushleft}
    #2 {\bf \normalsize #1}
\end{flushleft}}

\newcommand{\G}{\Gamma}
\newcommand{\D}{\Delta}
\newcommand{\V}{\vdash}
\newcommand{\VT}{\vdash\hspace{-.50em}\raisebox{0.28em}{\tiny{$\TB$}}}
\newcommand{\iskind}{\text{\ kind}}
\newcommand{\TW}{\triangleright}
\newcommand{\TWL}{\triangleleft}
\newcommand{\F}{\forall}
\newcommand{\TB}{\blacktriangleright}
\newcommand{\TBL}{\blacktriangleleft}
\newcommand{\E}{\equiv}
\newcommand{\FV}{\text{FV}}
\newcommand{\FTV}{\text{FTV}}

\newcommand{\WStar}{\textsc{W-Star}}
\newcommand{\WAbs}{\textsc{W-Abs}}
\newcommand{\WCsp}{\textsc{W-Csp}}
\newcommand{\WApp}{\textsc{W-App}}
\newcommand{\WTW}{\textsc{W-$\TW$}}

\newcommand{\KVar}{\textsc{K-Var}}
\newcommand{\KAbs}{\textsc{K-Abs}}
\newcommand{\KApp}{\textsc{K-App}}
\newcommand{\KConv}{\textsc{K-Conv}}
\newcommand{\KTW}{\textsc{K-$\TW$}}
\newcommand{\KTWL}{\textsc{K-$\TWL$}}
\newcommand{\KGen}{\textsc{K-Gen}}
\newcommand{\KCsp}{\textsc{K-Csp}}

\newcommand{\TVar}{\textsc{T-Var}}
\newcommand{\TAbs}{\textsc{T-Abs}}
\newcommand{\TApp}{\textsc{T-App}}
\newcommand{\TConv}{\textsc{T-Conv}}
\newcommand{\TTB}{\textsc{T-$\TB$}}
\newcommand{\TTBL}{\textsc{T-$\TBL$}}
\newcommand{\TGen}{\textsc{T-Gen}}
\newcommand{\TIns}{\textsc{T-Ins}}
\newcommand{\TCsp}{\textsc{T-Csp}}

\newcommand{\QKAbs}{\textsc{QK-Abs}}
\newcommand{\QKCsp}{\textsc{QK-Csp}}
\newcommand{\QKRefl}{\textsc{QK-Refl}}
\newcommand{\QKSym}{\textsc{QK-Sym}}
\newcommand{\QKTrans}{\textsc{QK-Trans}}

\newcommand{\QTAbs}{\textsc{QT-Abs}}
\newcommand{\QTApp}{\textsc{QT-App}}
\newcommand{\QTTW}{\textsc{QT-$\TW$}}
\newcommand{\QTGen}{\textsc{QT-Gen}}
\newcommand{\QTCsp}{\textsc{QT-Csp}}
\newcommand{\QTRefl}{\textsc{QT-Refl}}
\newcommand{\QTSym}{\textsc{QT-Sym}}
\newcommand{\QTTrans}{\textsc{QT-Trans}}

\newcommand{\QAbs}{\textsc{Q-Abs}}
\newcommand{\QApp}{\textsc{Q-App}}
\newcommand{\QTB}{\textsc{Q-$\TB$}}
\newcommand{\QTBL}{\textsc{Q-$\TBL$}}
\newcommand{\QGen}{\textsc{Q-Gen}}
\newcommand{\QIns}{\textsc{Q-Ins}}
\newcommand{\QCsp}{\textsc{Q-Csp}}
\newcommand{\QRefl}{\textsc{Q-Refl}}
\newcommand{\QSym}{\textsc{Q-Sym}}
\newcommand{\QTrans}{\textsc{Q-Trans}}
\newcommand{\QBeta}{\textsc{Q-$\beta$}}
\newcommand{\QEta}{\textsc{Q-$\eta$}}
\newcommand{\QTBLTB}{\textsc{Q-$\TBL\TB$}}
\newcommand{\QLambda}{\textsc{Q-$\Lambda$}}
\newcommand{\QPercent}{\textsc{Q-\%}}

\newcommand{\ID}[1]{\infer[]{#1}{\vdots}}
\newcommand{\MD}[1]{\mathcal{D}_#1}

\newcommand{\red}[1]{\textcolor{red}{ #1 }}
\newcommand{\blue}[1]{\textcolor{blue}{ #1 }}

\title{Multistage Programming with Dependent Type}

\author{Akira KAWATA}
\date{\today}

\begin{document}

\maketitle

\red{Red part means ommision.}

\blue{Blue part means just a comment.}

\section{ $ \lambda^{\text{MD}} $ }

\figheader{Syntax}{}

\begin{align*}
    \textrm{Terms} && M,N,L,O,P & ::= x \mid \lambda x:\tau.M\ \mid M\ M \mid \TB_\alpha M 
    \mid \TBL_\alpha M \mid \Lambda\alpha.M \mid M\ \epsilon \mid \%_\alpha M\\ 
    \textrm{Types} && \tau,\sigma,\rho,\pi,\xi & ::= X \mid \Pi x:\tau.\tau \mid \tau\ M \mid \TW_{\alpha} M \mid \F\alpha.\tau \\
    \textrm{Kinds} && K,J,I,H,G & ::= * \mid \Pi x:\tau.K\\
    \textrm{Contexts} && \Gamma & ::= \phi \mid 
    \Gamma,x:\tau@A\ (x\not\in\textrm{FV}(\G)) \\
    \textrm{Transition variables} && & \alpha,\beta,\gamma,... \\
    \textrm{Transition} && & A,B,C,... \\
    \textrm{Variables} && & x,y,z,... \\
    \textrm{Type variables} && & X,Y,Z,... \\
\end{align*}

\figheader{Well-formed kinds}{\rulefbox{\Gamma \vdash K\iskind @A}}
\begin{center}
    \infrule{}{\G\V*\iskind @A}{\WStar} \andalso
    \infrule{\G\V \tau::*@A \andalso \G,x:\tau@A\V K\iskind @A}{\G\V(\Pi x:\tau.K)\iskind @A}{\WAbs}\andalso
\end{center}

\figheader{Kinding}{\rulefbox{\G \V T::K @ A}}
\begin{center}
    \infrule{X::K@A \in \G \andalso \G\V K\iskind @A}{\G \V X::K@A}{\KVar} \andalso
    \infrule{\G\V \tau :: *@A \andalso \G,x:\tau@A\V \sigma::J@A}{\G\V(\Pi x:\tau.\sigma) :: (\Pi x:\tau.J)@A}{\KAbs} \\[2mm]
    \infrule{\G\V \sigma:: (\Pi x:\tau.K)@A \andalso \G\V M:\tau@A}{\G\V \sigma\ M::K[x\mapsto M]@A}{\KApp} \andalso
    \infrule{\G\V \tau::K@A \andalso \G\V K\equiv J@A}{\G\V \tau::J@A}{\KConv} \\[2mm]
    \infrule{\G\V \tau::*@A\alpha}{\G\V\TW_\alpha \tau::*@A}{\KTW}\andalso
    \infrule{\G\V \tau::K@A \andalso \alpha\notin\rm{FTV}(\G)\cup\rm{FTV}(A)}{\G\V\forall\alpha.\tau::K@A}{\KGen} \andalso
    \infrule{\G\V \tau::*@A}{\G\V \tau::*@A\alpha}{\KCsp}
\end{center}

\figheader{Typing}{\rulefbox{\G\V M:\tau @A}}
\begin{center}
    \infrule{x:\tau@A \in \G \andalso \G\V \tau::*@A}{\G \V x:\tau@A}{\TVar} \andalso
    \infrule{\G\V \sigma::*@A\andalso\G,x:\sigma@A\V M:\tau@A}{\G\V(\lambda (x:\sigma).M):(\Pi (x:\sigma).\tau)@A}{\textsc{T-Abs}} \\[2mm]
    \infrule{\G\V M:(\Pi (x:\sigma).\tau)@A \andalso \G\V N:\sigma@A}{\G\V M\ N : \tau[x\mapsto N]@A}{\textsc{T-App}} \andalso
    \infrule{\G\V M:\tau@A \andalso \G\V \tau\equiv \sigma :: K@A}{\G\V M:\sigma@A}{\textsc{T-Conv}} \\[2mm]
    \infrule{\G\V M:\tau@{A\alpha}}{\G\V\TB_{\alpha}M:\TW_{\alpha}\tau@A}{\textsc{T-$\TB$}} \andalso
    \infrule{\G\V M:\TW_{\alpha}\tau@A}{\G\V\TBL_{\alpha}M:\tau@{A\alpha}}{\TTBL} \\[2mm]
    \infrule{\G\V M:\tau@A \andalso \alpha\notin\rm{FTV}(\G)\cup\rm{FTV}(A)}{\G\V\Lambda\alpha.M:\forall\alpha.\tau@A}{\textsc{T-Gen}} \andalso
    \infrule{\G\V M:\forall\alpha.\tau@A}{\G\V M\ \epsilon:\tau[\alpha \mapsto \epsilon]@A}{\textsc{T-Ins}} \andalso
    \infrule{\G\V M:\tau@A}{\G\V \%_\alpha M:\tau@{A\alpha}}{\textsc{T-Csp}} \andalso
\end{center}
\figheader{Term reduction}{\rulefbox{M \to N}}
\begin{center}
    \begin{align*}
        & (\lambda x:\tau.M) N \longrightarrow_\beta M[x \mapsto N] \\
        % & (\Pi x:\tau.\sigma) M \longrightarrow_\gamma \sigma[x \mapsto M] \\
        & \TBL_\alpha (\TB_\alpha M)\longrightarrow_\blacklozenge M \\
        & (\Lambda \alpha.M) \epsilon \longrightarrow_\Lambda M[\alpha \mapsto \epsilon]
    \end{align*}
\end{center}
And take a minimum compatible relationship on terms.

\newpage
\figheader{Kind Equivalence}{\rulefbox{\G\V K\E J@A}}
\begin{center}
    Demands from syntax rules\\[2mm]
    \infrule{\G\V \tau \E \sigma :: *@A \andalso \G,x:\tau@A \V K \E J@A}{\G\V\Pi x:\tau.K \E \Pi x:\sigma.J@A}{\QKAbs} \andalso
    \infrule{\G\V K \E J@A}{\G\V K \E J@{A\alpha}}{\textsc{QK-Csp}} \\[4mm]
    Demands from equivalence relationship\\[2mm]
    \infrule{\G\V K \iskind @A}{\G\V K\E K@A}{\textsc{QK-Refl}} \andalso
    \infrule{\G\V K \E J@A}{\G\V J \E K@A}{\textsc{QK-Sym}} \andalso
    \infrule{\G\V K \E J@A \andalso \G\V J \E I@A}{\G\V K \E I@A}{\textsc{QK-Trans}} \\[4mm]
    % 簡約規則の要請\\[2mm]
\end{center}

\figheader{Type Equivalence}{\rulefbox{\G\V S\E T :: K @A}}
\begin{center}
    Demands from syntax rules\\[2mm]
    \infrule{\G\V \tau \E \sigma :: *@A \andalso \G,x:\tau@A \V \rho \E \pi :: *@A}{\G\V\Pi x:\tau.\rho \E \Pi x:\sigma.\pi :: *@A}{\QTAbs} \andalso
    \infrule{\G\V \tau \E \sigma :: (\Pi x:\rho.K)@A \andalso \G\V M \E N : \rho @A}{\G\V \tau\ M \E \sigma\ N :: K[x \mapsto M]@A}{\QTApp} \\[2mm]
    \infrule{\G\V \tau \E \sigma :: *@{A\alpha}}{\G\V \TW_{\alpha} \tau \E \TW_{\alpha} \sigma :: *@A}{\textsc{QT-$\TW$}}\andalso
    \infrule{\G\V \tau \E \sigma :: *@A \andalso \alpha\notin\rm{FTV}(\G)\cup\rm{FTV}(A)}{\G\V \forall\alpha.\tau \E  \forall\alpha.\sigma :: *@A}{\textsc{QT-Gen}} \andalso
    \infrule{\G\V \tau \E \sigma :: K@A}{\G\V \tau \E \sigma :: K@{A\alpha}}{\textsc{QT-Csp}} \\[4mm]
    Demands from equivalence relationship\\[2mm]
    \infrule{\G\V \tau::K@A}{\G\V \tau\E\tau :: K@A}{\textsc{QT-Refl}} \andalso
    \infrule{\G\V \tau \E \sigma :: K@A}{\G\V \sigma \E \tau :: K@A}{\textsc{QT-Sym}} \andalso
    \infrule{\G\V \tau \E \sigma :: K@A \andalso \G\V \sigma \E \rho  :: K@A}{\G\V \tau \E \rho  :: K@A}{\textsc{QT-Trans}} \\[4mm]
\end{center}

\figheader{Term Equivalence}{\rulefbox{\G\V M\E N : \tau @A}}
\begin{center}
    Demands from syntax rules\\[2mm]
    \infrule{\G\V \tau \E \sigma :: *@A \andalso \G,x:\tau@A \V M \E N : \rho @A}{\G\V\lambda x:\tau.M \E \lambda x:\sigma.N : (\Pi x:\tau.\rho)@A}{\QAbs} \andalso
    \infrule{\G\V M \E L : (\Pi x:\sigma.\tau)@A \andalso \G\V N \E O : \sigma@A}{\G\V M\ N \E L\ O : \tau[x \mapsto N]@A}{\QApp} \\[2mm]
    \infrule{\G\V M \E N : \tau@{A\alpha}}{\G\V \TB_\alpha M \E \TB_\alpha N : \TW_\alpha \tau@A}{\QTB} \andalso
    \infrule{\G\V M \E N : \TW_\alpha \tau@A}{\G\V \TBL_\alpha M \E \TBL_\alpha N : \tau@{A\alpha}}{\QTBL} \\[2mm]
    \infrule{\G\V M\E N : \tau@A \andalso \alpha \notin \FTV(\G)\cup\FTV(A)}{\G\V \Lambda\alpha.M \E \Lambda\alpha.N : \forall\alpha.\tau@A}{\QGen} \andalso
    \infrule{\G\V M \E N:\forall\alpha.\tau@A}{\G\V M\ \epsilon \E N\ \epsilon : \tau[\alpha \mapsto \epsilon]@A}{\QIns}\andalso
    \infrule{\G\V M \E N : \tau @A}{\G\V\%_\alpha M \E \%_\alpha N : \tau@{A\alpha}}{\QCsp} \\[4mm]
    Demands from equivalence relationship\\[2mm]
    \infrule{\G\V M:\tau@A}{\G\V M\E M : \tau@A}{\QRefl} \andalso
    \infrule{\G\V M\E N : \tau@A}{\G\V N\E M : \tau@A}{\QSym} \andalso
    \infrule{\G\V M\E N : \tau@A \andalso \G\V N\E L : \tau@A}{\G\V M\E L : \tau@A}{\QTrans} \\[4mm]
    Demands from reduction rule\\[2mm]
    \infrule{\G,x:\sigma@A\V M:\tau@A \andalso \G\V N:\sigma@A}{\G\V(\lambda x:\sigma.M)\ N\E M[x\mapsto N] : \tau[x \mapsto N]@A}{\QBeta} \andalso
    \infrule{\G\V M:(\Pi x:\sigma.\tau)@A \andalso x\notin \text{FV}(M)}{\G\V(\lambda x:\sigma.M\ x)\E M: (\Pi x:\sigma.\tau)@A}{\QEta} \\[2mm]
    \infrule{\G\V M \E N : \tau@A}{\G\V \TBL_\alpha(\TB_\alpha M) \E N : \tau @A}{\QTBLTB} \andalso
    \infrule{\G\V (\Lambda\alpha.M) : \forall\alpha.\tau@A}{\G\V (\Lambda\alpha.M)\ \epsilon \E M[\alpha \mapsto \epsilon] : \tau[\alpha \mapsto \epsilon]@A}{\QLambda} \\[2mm]
    \infrule{\G\V M:\tau@{A\alpha} \andalso \G\V M:\tau@A}{\G\V\%_\alpha M \E M : \tau@{A\alpha}}{\QPercent} \andalso
\end{center}

\begin{cm}
    Term equivalence is exists because of {$\textsc{QT-App}$}.
\end{cm}

\begin{cm}{Comment on \textsc{Q-\%}\\}
    We can use \textsc{Q-\%} expressions like a number literal expressions.\\
    Thus, $\G\V 5 :\text{Int} @A$ and $\G\V 5 : \text{Int} @ A\alpha$.\\
    Or closure expressions like the id function.\\
 \end{cm}

% \begin{cm}{Comment on \textsc{Q-\%}\\}
%  This rule is equivalent to a following rule.
%  \begin{center}
%      \infrule{\G\V\%_\alpha M::\tau@{A\alpha} \andalso \G\V N:\tau@{A\alpha} \andalso \G\V M \E N : \tau@A}
%      {\G\V\%_\alpha M \E N : \tau@{A\alpha}}{\textsc{Q-\%-2}} \andalso
%  \end{center}
%  Because
%  \begin{center}
%      $$
%      \infer[\textsc{Q-Trans}]
%      {\G\V\%_\alpha M \E N : \tau@{A\alpha}}
%      {
%         \infer[\textsc{Q-\%}]
%         {\G\V\%_\alpha N \E N@{A\alpha}}
%         {\G\V N:\sigma@{A\alpha} \andalso \G\V N:T'_2@A}
%         \andalso
%         \infer[\textsc{Q-Csp}]
%         {\G\V\%_\alpha M \E \%N : \tau@{A\alpha}}
%         {\G\V M \E N : \tau@{A}}
%      }
%      $$
%  \end{center}
% \end{cm}

\figheader{Example}{}

\iffullversion

\begin{ex}
    \newcommand{\M}{\textrm{M}}
    \newcommand{\I}{\textrm{I}}
    % \newcommand{\GF}{\textrm{GF}}
    An example of CSP using \% 
    \begin{align*}
        \I::*@\epsilon,\bar{5}:\I@\alpha\V ((\lambda(f:\Pi x:\I.\I).\TB_\alpha (\%_\alpha f\ \bar{5}))\ (\lambda x:\I.x)) : \TW_\alpha \I@\epsilon
    \end{align*}

    Type derivation is following.\\
    Set $\G$ as $\I::*@\epsilon,\bar{5}:\I@\alpha$.
    \begin{center}
        $$
        \infer[\textsc{T-App}]
        {\G\V (\lambda(f:\Pi (x:\I).\I).\TB_\alpha (\%_\alpha f\ \bar{5}))\ (\lambda x:\I.x) : \TW_\alpha\I@\epsilon}
        {\infer[\textsc{T-Abs}]
            {\G\V (\lambda(f:\Pi (x:\I).\I).\TB_\alpha (\%_\alpha f\ \bar{5})):\Pi (f:\Pi (x:\I).\I).\TW_\alpha \I@\epsilon}
            {\infer[\textsc{T-$\TB$}]
                {\G ,f:\Pi (x:\I).\I@\epsilon \V \TB_\alpha (\%_\alpha f\ \bar{5})):\TW_\alpha \I@\epsilon}
                {\infer[\textsc{T-App}]
                    {\G ,f:\Pi (x:\I).\I@\epsilon \V\%_\alpha f\ \bar{5}: \I@\alpha}
                    {\infer[\textsc{T-Csp}]
                        {\G ,f:\Pi (x:\I).\I@\epsilon \V \%_\alpha f\ : \Pi (x:\I).\I@\alpha}
                        {\infer[]{\G ,f:\Pi (x:\I).\I@\epsilon \V f: \Pi (x:\I).\I@\epsilon}{\vdots}}
                        \andalso
                        \infer[]
                        {\G\ldots \V \bar{5}: \I@\alpha}
                        {\vdots}
                    }
                }
            }\andalso
            \infer[\textsc{T-Abs}]
            {\G\V(\lambda x:\I.x):\Pi (x:\I).\I@\epsilon}
        {
    \infer[]{\G,x:\I@\epsilon\V x:\I@\epsilon}{\vdots} \andalso \infer[]{\I::*@\epsilon,\bar{5}:\I@\alpha\V\I::*@\epsilon}{\vdots}}}
        $$
    \end{center}
\end{ex}

\begin{ex}
    \newcommand{\M}{\textrm{M}}
    \newcommand{\MM}{\textrm{M}\ 13}
    \newcommand{\I}{\textrm{I}}
    We can type this example, because $(\%_\alpha\ 13) \E 13$.\\
    \begin{align*}
        \I::*@\epsilon,\M::(\Pi (x:\I).*)@\epsilon,13:\I@\epsilon,13:\I@\alpha,\bar{5}:\M\ 13@\epsilon\V\TB_\alpha ((\lambda (y:\M (\%_\alpha 13)).y)\ \bar{5}):\TW_\alpha \M\ 13@\alpha
    \end{align*}

    Type derivation is following.\\
    Set $\G$ as $\I::*@\epsilon,\M::(\Pi (x:\I).*)@\epsilon,13:\I@\epsilon,13:\I@\alpha,\bar{5}:\M\ 13@\alpha$.\\
    Set $p_1$ as $\G,y:\M (\%_\alpha 13)@\alpha \V y:\M (\%_\alpha 13)@\alpha$.\\
    Set $p_2$ as $\G,y:\M (\%_\alpha 13)@\alpha \V \M (\%_\alpha 13)\E\MM@\alpha$.
    \begin{center}
        $$
        \infer[\textsc{T-$\TB$}]
        {\G\V\TB_\alpha ((\lambda (y:\M (\%_\alpha 13)).y)\ \bar{5}):\TW_\alpha \MM@\epsilon}
        {
            \infer[\textsc{T-App}]
            {\G\V (\lambda (y:\M (\%_\alpha 13)).y)\ \bar{5}:\M\ 13@\alpha}
            {
                \infer[\textsc{T-Abs}]
                {\G\V (\lambda (y:\M (\%_\alpha 13)).y):\Pi (y:\MM).\M\ 13@\alpha}
                {
                    \infer[\textsc{T-Conv}]
                    {\G,y:\M (\%_\alpha 13)@\alpha \V y:\MM@\alpha}
                    {\infer[]{p_1}{\textrm{(goto label-$p_1$)}} \andalso \infer[]{p_2}{\textrm{(goto label-$p_2$)}}}
                    \andalso
                    \infer[\textsc{K-Csp}]
                    {\G\V \M (\%_\alpha 13):*@\alpha}
                    {
                        \infer[]
                        {\G\V \M (\%_\alpha 13):*@\epsilon}
                        {\vdots}
                    }
                }
                \andalso
                \infer[]
                {\G\V \bar{5}:\MM@\alpha}
                {\vdots}
            }
        }
        $$
    \end{center}
    label-$p_1$:\\
    Set $\G'$ as $\I::*@\epsilon,\M::(\Pi (x:\I).*)@\epsilon,13:\I@\epsilon,13:\I@\alpha,\bar{5}:\M\ 13@\alpha,y:\M (\%_\alpha 13)@\alpha$.\\
    Type derivation of $p_1$.
    \begin{center}
        $$
        \infer[\textsc{T-Var}]
        {\G,y:\M (\%_\alpha 13)@\alpha \V y:\M (\%_\alpha 13)@\alpha}
        {
            \infer[\textsc{K-App}]
            {\G' \V \M (\%_\alpha 13)::*@\alpha}
            {
                \infer[\textsc{K-Csp}]
                {\G'\V \M::\Pi (x:\I).*@\alpha}
                {
                    \infer[]
                    {\G'\V \M::\Pi (x:\I).*@\epsilon}
                    {\vdots}
                }
                \andalso
                \infer[\textsc{T-Csp}]
                {\G'\V (\%_\alpha 13):\I@\alpha}
                {
                    \infer[]
                    {\G'\V 13:\I@\epsilon}
                    {\vdots}
                    \andalso
                }
            }
        }
        $$
    \end{center}
    label-$p_2$:\\
    {\bf{Type derivation of $p_2$}.}\\
    Set $\G'$ as $\I::*@\epsilon,\M::(\Pi (x:\I).*)@\epsilon,13:\I@\epsilon,13:\I@\alpha,\bar{5}:\M\ 13@\alpha,y:\M (\%_\alpha 13)@\alpha$.\\
    abbr. means abbreviation defined in the top of page 1.
    \begin{center}
        $$
        \infer[\textsc{QT-App}]
        {\G,y:\M (\%_\alpha 13)@\alpha \V \M (\%_\alpha 13)\E\MM@\alpha}
        {
            \infer[\textrm{abbr.}]
            {\G' \V \M\E\M::(\Pi (x:\I).*)@\alpha}
            {
                \infer[\textsc{QT-Csp}]
                {\G' \V \M\E\M@\alpha}
                {
                    \infer[\textsc{QT-Refl}]
                    {\G\V \M\E\M@\epsilon}
                    {
                        \infer[]
                        {\G\V \M::(\Pi (x:\I).*)@\epsilon}
                        {
                            \vdots
                        }
                    }
                }
                \andalso
                \infer[\textsc{K-Csp}]
                {\G' \V \M::(\Pi (x:\I).*)@\alpha}
                {
                    \infer[]
                    {\G \V\M::(\Pi (x:\I).*)@\epsilon}
                    {\vdots}
                }
            }
            \andalso
            \infer[\textrm{abbr.}]
            {\G' \V (\%_\alpha 13)\E 13:\I@\alpha}
            {
                \infer[\textsc{Q-\%}]
                {\G' \V (\%_\alpha 13)\E 13@\alpha}
                {
                    \infer[\textsc{Q-\%}]
                    {\G' \V (\%_\alpha 13):\I@\alpha}
                    {
                        \infer[]
                        {\G' \V 13:\I@\epsilon}
                        {\vdots}
                    }
                    \andalso
                    \infer[]
                    {\G' \V 13:\I@\alpha}
                    {\vdots}
                }
                \andalso
                \infer[]
                {\G' \V 13:\I@\alpha}
                {\vdots}
            }
        }
        $$
    \end{center}
\end{ex}

\begin{ex}
    \newcommand{\M}{\textrm{Mod}}
    \newcommand{\I}{\textrm{Int}}
    \newcommand{\GF}{\textrm{GF}}
    We cannot type this example, because $(\%_\alpha\ x) \not\E 13$.\\
    More precisely, our type equivalence rule cannot capture the information that "$x$ is bound to $13$".\\

    Set $\G$ as $\I::*@\epsilon,\M::(\Pi (x:\I).*)@\epsilon,13:\I@\epsilon,\bar{5}:\M\ 13@\alpha$.
    \begin{align*}
        \G\V
        (\lambda (x:\I).
        (\TB_\alpha ((\lambda (y:\M (\%_\alpha x)).y)\ \bar{5})))\ 13):\TW_\alpha \M\ 13@\epsilon
    \end{align*}
\end{ex}

\fi

\begin{ex}
    \newcommand{\I}{\textrm{Int}}
    \newcommand{\B}{\textrm{Bool}}
    \newcommand{\RI}{\textrm{RInt}}
    \newcommand{\rI}{\textrm{rInt}}
    \rI\ is a primitive function with a type of $\rI : \I \to (\RI\ \text{true})$.\\
    \RI\ is a primitive type constructor with a kind of $\RI : \B \to *$.
    \begin{align*}
        \text{let}\ & power3\ n = \hdots \\
        & power3 : \forall\alpha. \TW_\alpha(\I \to \I) \\
        \text{let}\ & tested\_power3\ x = (\rI\ ((power3\ \epsilon)\ x)) \\
        & tested\_power3 : \I \to (\RI\ ((power3\ \epsilon)\ 2 == 8\ \&\&\ (power3\ \epsilon)\ 1 == 1)) \\
    \end{align*}
    When you use $tested\_power3$, it is guranteed that $tested\_power3$ pass the test.
\end{ex}

\begin{ex}
    \newcommand{\I}{\textrm{Int}}
    \newcommand{\Exp}{\textrm{Str}}
    \newcommand{\RI}{\textrm{RFun}}
    \newcommand{\rI}{\textrm{rFun}}
    \rI\ is a primitive function with a type of $\rI : (\forall\alpha.\TW_\alpha(\I \to \I)) \to (\RI\ \text{true})$.\\
    == between codes is a primitive function which return true for $\alpha$ equivalence pair.
    \begin{align*}
        \text{let}\ & staged\_intepreter\ str = \hdots \\
        & staged\_intepreter : \Exp \to \forall\alpha.\TW_\alpha(\I \to \I) \\
        \text{let}\ & tested\_staged\_intepreter\ str = (\rI\ (staged\_intepreter\ str)) \\
        & tested\_staged\_intepreter : \Exp \to (\RI\ (staged\_intepreter\ "\lambda x:\I.x" == \Lambda\alpha.\TB_\alpha (\lambda x:\I.x)) \\
    \end{align*}
\end{ex}

\begin{ex}
    \newcommand{\I}{\textrm{Int}}
    \newcommand{\M}{\textrm{Mat}}
    \begin{align*}
        \text{mulmat} &: \Pi x:\I.\Pi y:\I.(\TW_\alpha \Pi z:\I.(\M\ \%_\alpha x\ \%_\alpha y) \to (\M\ \%_\alpha y\ z) \to (\M\ \%_\alpha x\ z)) \\
        \text{mulmat}\ 3\ 5 &: \TW_\alpha \Pi z:\I.(\M\ \%_\alpha 3\ \%_\alpha 5) \to (\M\ \%_\alpha 5\ z) \to (\M\ \%_\alpha 3\ z) \\
        & (\E \TW_\alpha \Pi z:\I.(\M\ 3\ 5) \to (\M\ 5\ z) \to (\M\ 3\ z) ) \\
    \end{align*}
\end{ex}

\figheader{Theorem}{}

\iffullversion
I remove this lemma because it is not needed anywhere.
\begin{thm}[Weakening lemma for variables]
    \begin{flalign*}
        \text{If\ } \G \V M:\tau@A \text{\ then\ }& \G, z:\xi@B \V M:\tau@A &\\
        \text{If\ } \G \V M:\tau@A \text{\ then\ }& \G, Z:G@B \V M:\tau@A &\\
        \text{If\ } \G \V \tau::K@A \text{\ then\ }& \G, z:\xi@B \V \tau::K@A &\\
        \text{If\ } \G \V \tau::K@A \text{\ then\ }& \G, Z:G@B \V \tau::K@A &\\
        \text{If\ } \G \V K\iskind@A \text{\ then\ }& \G, z:\xi@B \V K\iskind@A &\\
        \text{If\ } \G \V K\iskind@A \text{\ then\ }& \G, Z:G@B \V K\iskind@A &\\
        \text{If\ } \G \V M\E N : \tau@A \text{\ then\ }& \G, z:\xi@B \V M\E N : \tau@A &\\
        \text{If\ } \G \V M\E N : \tau@A \text{\ then\ }& \G, Z:G@B \V M\E N : \tau@A &\\
        \text{If\ } \G \V \tau\E \sigma : K@A \text{\ then\ }& \G, z:\xi@B \V \tau\E \sigma : K@A &\\
        \text{If\ } \G \V \tau\E \sigma : K@A \text{\ then\ }& \G, Z:G@B \V \tau\E \sigma : K@A &\\
        \text{If\ } \G \V K\E J@A \text{\ then\ }& \G, z:\xi@B \V K\E J@A &\\
        \text{If\ } \G \V K\E J@A \text{\ then\ }& \G, Z:G@B \V K\E J@A &\\
    \end{flalign*}    
\end{thm}

Prove by induction on derivation tree.

\begin{itemize}
    \item \WStar
    
    From the definition of \WStar.

\end{itemize}
\fi

\begin{thm}[Substituition Lemma for Variables of Terms, Types or Kinds and Their Equivalence]
    \begin{flalign*}
        \text{If\ } \G,z:\xi@B \V M:\tau@A \text{\ and\ } \G\V P:\xi@B
        &\text{\ then\ } \G\V M[z \mapsto P]:\tau[z \mapsto P]@A.&\\
        \text{If\ } \G,z:\xi@B \V \tau::K@A \text{\ and\ } \G\V P:\xi@B
        &\text{\ then\ } \G\V \tau[z \mapsto P]::K[z \mapsto P]@A.&\\
        \text{If\ } \G,z:\xi@B \V K\iskind@A \text{\ and\ } \G\V P:\xi@B
        &\text{\ then\ } \G\V K[z \mapsto P] \iskind @A.&\\
        \text{If\ } \G,z:\xi@B \V M\E N : \tau@A \text{\ and\ } \G\V P:\xi@B
        &\text{\ then\ } \G\V M[z \mapsto P]\E N[z \mapsto P] : \tau[z \mapsto P]@A.&\\
        \text{If\ } \G,z:\xi@B \V \tau\E \sigma : K@A \text{\ and\ } \G\V P:\xi@B
        &\text{\ then\ } \G\V \tau[z \mapsto P]\E \sigma[z \mapsto P] : K[z \mapsto P]@A.&\\
        \text{If\ } \G,z:\xi@B \V K\E J@A \text{\ and\ } \G\V P:\xi@B
        &\text{\ then\ } \G\V K[z \mapsto P]\E J[z \mapsto P]@A.&
    \end{flalign*}    
\end{thm}

Prove by induction on derivation tree.

\begin{itemize}

    \newcommand{\SB}{[z \mapsto P]}
    \newcommand{\GG}{\G}
    \newcommand{\GGV}{\G \V}

    \iffullversion

    \item \WStar
    
        From the definition of \WStar, we can get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\WStar]
        {\GGV * \iskind @A}
        {}

    \item \WAbs
    
        We can assume $x \neq z$ because we can select fresh $x$ when we construct $\Pi$ type.
    
        We have two derivation trees from the premise.

        $\mathcal{D}_1$ = \infer[\WAbs]
        {\G, z:\xi@B, \D \V (\Pi x:\tau.K) \iskind @A}
        {\G, z:\xi@B, \D \V T::*@A \andalso \G, z:\xi@B, \D, x:\tau \V K \iskind@A}

        $\mathcal{D}_2$ = \infer[]
        {\G \V P:\xi@B}
        {\vdots}\
        
        We can get $\mathcal{D}_3$ by use the induction hypothesis to $\mathcal{D}_1$
        
        $\mathcal{D}_3$ = \infer[\WAbs]
        {\GGV (\Pi x:\tau\SB.K\SB) \iskind @A}
        {
            \infer[]{\GGV T\SB::*@A}{\vdots} \andalso 
            \infer[]{\GG, x:\tau\SB \V K\SB \iskind@}{\vdots}
        }\\

        Following relationship is obvious.\\
        $\GGV (\Pi x:\tau\SB.K\SB) \iskind @A$\\
        is equivalent with\\
        $\GGV (\Pi x:\tau.K)\SB \iskind @A$.\\

        Then, we can get $\mathcal{D}'_3$ from $\mathcal{D}_3$.

        $\mathcal{D}'_3$ = \infer[\WAbs]
        {\GGV (\Pi x:\tau.K)\SB \iskind @A}
        {
            \infer[]{\GGV T\SB::*@A}{\vdots} \andalso 
            \infer[]{\GG, x:\tau\SB \V K\SB \iskind@}{\vdots}
        }\\

    \item \WCsp

        From the induction hypothesis, we can get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[]
        {\GGV K\SB \iskind @A}
        {\vdots}

        Use \WCsp,

        $\mathcal{D}_2$ = \infer[\WCsp]
        {\GGV K\SB \iskind @A\alpha}
        {\mathcal{D}_1}
    
    \item \WTW
    
        From the induction hypothesis, we can get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[]
        {\GGV K\SB \iskind @A\alpha}
        {\vdots}

        Use \WTW,

        $\mathcal{D}_2$ = \infer[\WTW]
        {\GGV K\SB \iskind @A\alpha}
        {\mathcal{D}_1}
    
    \item \KVar

        From the induction hypothesis, we can get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[]
        {\GGV K\SB \iskind @A\alpha}
        {\vdots}

        And we can easily show that $X::K\SB@A \in \GG$.

        Then we can use \KVar\ and get $\mathcal{D}_2$.

        $\mathcal{D}_2$ = \infer[\KVar]
        {\GGV X :: K\SB @A}
        {X::K\SB@A \in \GG \andalso \mathcal{D}_1}

    \item \KAbs
    
        From the induction hypothesis, we can get $\mathcal{D}_1$ and $\mathcal{D}_2$.

        $\mathcal{D}_1$ = \infer[]
        {\GGV \tau\SB :: * @ A}
        {\vdots}

        $\mathcal{D}_2$ = \infer[]
        {\GG, x:\tau\SB@A\V \sigma\SB::J\SB@A}
        {\vdots}

        Use \KAbs,

        $\mathcal{D}_3$ = \infer[\KAbs]
        {\GGV (\Pi x:\tau\SB.\sigma\SB)::(\Pi x:\tau\SB.J\SB)@A}
        {\mathcal{D}_1 \andalso \mathcal{D}_2}

        We can arrange the substitution.

        $\mathcal{D}'_3$ = \infer[\KAbs]
        {\GGV (\Pi x:\tau.\sigma)\SB::(\Pi x:\tau.J)\SB@A}
        {\mathcal{D}_1 \andalso \mathcal{D}_2}

    \item \KApp
    
        Because the last rule is \KApp, we have a derivation tree $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\KApp]
        {\G, z:\xi@B, \D\V \sigma\ M :: K[x \mapsto M]}
        {\infer[]
        {\G, z:\xi@B, \D\V \sigma::(\Pi x:\tau.K)@A}{\vdots} \andalso 
        \infer[]
        {\G, z:\xi@B, \D\V M:\tau@A}
        {\vdots}}

        From the induction hypothesis, we can get $\mathcal{D}_2$ and $\mathcal{D}_3$.

        $\mathcal{D}_2$ = \infer[]
        {\GGV \sigma\SB::(\Pi x:\tau.K)\SB@A}
        {\vdots}

        Because $x \neq z$, we can write

        $\mathcal{D}'_2$ = \infer[]
        {\GGV \sigma\SB::(\Pi x:\tau\SB.K\SB)@A}
        {\vdots}

        $\mathcal{D}_3$ = \infer[]
        {\GGV M\SB:\tau\SB@A}
        {\vdots}

        Use \KApp,

        $\mathcal{D}_4$ = \infer[\KApp]
        {\GGV (\sigma\SB\ M\SB)::K\SB[x \mapsto M]@A}
        {\mathcal{D}'_2 \andalso \mathcal{D}_3}

        There is no $x$ in $P$ and no $z$ in $M$ because of freshness. So we can rewrite the $\mathcal{D}_4$.

        $\mathcal{D}_4$ = \infer[\KApp]
        {\GGV (\sigma\ M)\SB::K[x \mapsto M]\SB@A}
        {\mathcal{D}'_2 \andalso \mathcal{D}_3}
  
    \item \KConv
    
        From the induction hypothesis, we have $\mathcal{D}_1$ and $\mathcal{D}_2$.

        $\mathcal{D}_1$ = \infer[]
        {\GGV \tau\SB : K[z\mapsto P]@A}
        {\vdots}

        $\mathcal{D}_2$ = \infer[]
        {\GGV K\SB \E J\SB @A}
        {\vdots}

        Use \KConv,

        $\mathcal{D}_2$ = \infer[\KConv]
        {\GGV \tau\SB : J[z\mapsto P]@A}
        {\mathcal{D}_1 \andalso \mathcal{D}_2}

    \item \KTW
    
        From the induction hypothesis, we have $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[]
        {\GGV \tau\SB :: K\SB @ A\alpha}
        {\vdots}

        Use \KTW,

        $\mathcal{D}_2$ = \infer[]
        {\GGV \TW_\alpha \tau\SB :: K\SB @ A}
        {\mathcal{D}_1}

    \item \KTWL
    
         From the induction hypothesis, we have $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[]
        {\GGV \TW_\alpha \tau\SB :: K\SB @ A\alpha}
        {\vdots}

        Use \KTWL,

        $\mathcal{D}_2$ = \infer[]
        {\GGV \tau\SB :: K\SB @ A\alpha}
        {\mathcal{D}_1}
        
    \item \KGen
    
        From the induction hypothesis, we have $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[]
        {\GGV \tau\SB :: K\SB @ A}
        {\vdots}

        And we can prove easily $\alpha \notin \FTV(\GG) \cup \FTV(A)$.

        Use \KGen,

        $\mathcal{D}_2$ = \infer[\KGen]
        {\GGV \forall\alpha.\tau\SB :: K\SB @ A}
        {\mathcal{D}_1 \andalso \alpha \notin \FTV(\GG) \cup \FTV(A)}

    \item \KCsp

        From the induction hypothesis, we have $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[]
        {\GGV \tau\SB :: K\SB @ A}
        {\vdots}

        Use \KCsp,

        $\mathcal{D}_2$ = \infer[\KCsp]
        {\GGV \tau\SB :: K\SB @ A\alpha}
        {\GGV \tau\SB :: K\SB @ A}

    \fi

    \item \TVar
     
        We have two derivation trees from the premise.
        
        $\mathcal{D}_1$ = \infer[\TVar]
        {\G, z:\xi@B \V y:\tau@A}
        {y:\tau@A \in \G, z:\xi@B  \andalso \infer[]{\G, z:\xi@B \V \tau::*@A}{\vdots}}
                
        $\mathcal{D}_2$ = \infer[]
        {\G \V P:\xi@B}
        {\vdots}\\
 
        We can get $\mathcal{D}_3$ by use the induction hypothesis to $\mathcal{D}_1$.

        $\mathcal{D}_3$ = \infer[]
        {\GGV \tau\SB::*\SB@A}
        {\vdots}\\
  
        \begin{itemize}
            \item $y:\tau@A \in \G$ or $y:\tau@A \in \D$
            
                $\mathcal{D}_4$ is obvious.

                $\mathcal{D}_4$ = $y:\tau\SB@A \in \GG$

                Get $\mathcal{D}_5$ by using \TVar\ for $\mathcal{D}_3$, $\mathcal{D}_4$.
                
                $\mathcal{D}_5$ = \infer[]
                {\GGV y\SB:\tau\SB@A}
                {\mathcal{D}_4 \andalso \mathcal{D}_5}

            \item $y:\tau@A = z:\xi@B$
            
                In this case, 
                \begin{itemize}
                    \item $y = z$
                    \item $\tau = \xi$
                    \item $A = B$
                \end{itemize}
                
                Because there is no $z$ in $\xi$, $\tau\SB = \xi\SB = \xi$.
                And it is obvious that $y\SB = z\SB = P$.

                From $\mathcal{D}_2$, $\G \V y\SB : \tau\SB@A$. Use Weakening lemma, $\GGV y\SB : \tau\SB$.
        \end{itemize}

        From and \TVar\\
        $\GGV y\SB:\tau\SB$

    \iffullversion
        
    \item \TAbs

        From the induction hypothesis and \TAbs, we get

        $\mathcal{D}_1$ = \infer[\TAbs]
        {\GGV (\lambda y:\sigma\SB.M\SB):(\Pi y:\sigma\SB.\tau\SB)@A}
        {\infer[]{\GGV \sigma\SB::*@A}{\vdots} \andalso \infer[]{\GG, y:\sigma\SB@A \V M\SB:\tau\SB@A}{\vdots}}

        Arrange substitutions, 

        $\mathcal{D}'_1$ = \infer[\TAbs]
        {\GGV (\lambda y:\sigma.M)\SB:(\Pi y:\sigma.\tau)\SB@A}
        {\infer[]{\GGV \sigma\SB::*@A}{\vdots} \andalso \infer[]{\GG, y:\sigma\SB@A \V M\SB:\tau\SB@A}{\vdots}}

    \item \TApp

        We have a derivation trees from the premise.
        
        $\mathcal{D}_1$ = \infer[\TApp]
        {\G, z:\xi@B, \D \V M\ L:\tau[y\mapsto L]@A}
        {\infer[]{\G, z:\xi@B, \D \V M:\Pi(y:\rho).\tau@A \andalso \G, z:\xi@B, \D \V L:\rho@A}{\vdots}}
        
        We get 2 trees from the induction hypothesis and $\mathcal{D}_1$.

        $\mathcal{D}_2$ = \infer[]
        {\GGV M\SB: (\Pi(y:\rho).\tau)\SB@A}
        {\vdots}

        and

        $\mathcal{D}_3$ = \infer[]
        {\GGV L\SB: \rho\SB@A}
        {\vdots}

        \red{distribute the substitution} in $\mathcal{D}_2$

        $\mathcal{D'}_2$ = \infer[]
        {\GGV M\SB: (\Pi(y:\rho\SB).\tau\SB)@A}
        {\vdots}

        From $\mathcal{D'}_2$ and $\mathcal{D}_3$
        
        $\mathcal{D}_4$ = \infer[\TApp]
        {\GGV (M\SB\ L\SB): \tau\SB[y \mapsto L]@A}
        {\mathcal{D'}_2 \andalso \mathcal{D}_3}

        \red{We can transform the conclusion of $\mathcal{D}_4$ into} \\
        $\GGV (M\ L)\SB: \tau[y \mapsto L]\SB@A$

    \item \TConv
    
        We have 2 derivation trees from the premise and the induction hypothesis.

        $\mathcal{D}_1$ = \infer[]
        {\GGV t\SB:T\SB@A}
        {\vdots}

        $\mathcal{D}_2$ = \infer[]
        {\GGV T\SB \E T'\SB@A}
        {\vdots}

        And then \\
        \infer[\TConv]
        {\GGV t\SB:T'\SB@A}
        {\mathcal{D}_1 \andalso \mathcal{D}_2}

    \item \TTB

        From the induction hypothesis and \TTB, we get
        
        $\mathcal{D}_3$ = \infer[\TTB]
        {\GGV \TB_\alpha M\SB:\tau\SB@A}
        {\infer[]{\GGV M\SB:\tau\SB@A\alpha}{\vdots}}    

    \item \TTBL

        From the induction hypothesis and \TTBL, we get
        
        $\mathcal{D}_3$ = \infer[\TTBL]
        {\GGV \TBL_\alpha M\SB:\tau\SB@A}
        {
            \infer[]{\GGV M\SB: \TW_\alpha \tau\SB@A\alpha}{\vdots}
        }

    \item \TGen
    
        From the induction hypothesis, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[]
        {\GGV M\SB:\tau\SB@A}
        {\vdots}

        And we can prove easily $\alpha \notin \FTV(\GG) \cup \FTV(A)$.

        Use \TGen,

        $\mathcal{D}_2$ = \infer[\TGen]
        {\GGV (\Lambda\alpha.M)\SB:(\forall\alpha.\tau)\SB@A}
        {\mathcal{D}_1 \andalso \alpha \notin \FTV(\GG) \cup \FTV(A)}

    \item \TIns
    
        From the induction hypothesis, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[]
        {\GGV M\SB:(\forall\alpha.\tau)\SB@A}
        {\vdots}

        Use \TIns,

        $\mathcal{D}_2$ = \infer[\TIns]
        {\GGV (M\ \epsilon)\SB:\tau\SB@A}
        {\mathcal{D}_1}

    \item \TCsp
     
        From the induction hypothesis, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[]
        {\GGV M\SB:\tau\SB@A}
        {\vdots}

        Use \TCsp,

        $\mathcal{D}_2$ = \infer[\TCsp]
        {\GGV (\%_\alpha M)\SB:\tau\SB@A\alpha}
        {\mathcal{D}_1}

    \item \QKAbs
        
        From the induction hypothesis and \QKAbs, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QKAbs]
        {\GGV (\Pi x:\tau.K)\SB \E (\Pi x:\sigma.J)\SB@A}
        {\infer[]{\GGV \tau\SB \E \sigma\SB :: *@A}{\vdots} \andalso 
        \infer[]{\GG,x:\tau@A \V K\SB\E J\SB@A}{\vdots} }

    \item \QKCsp
        
        From the induction hypothesis and \QKCsp, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QKCsp]
        {\GGV K\SB \E J\SB @A\alpha}
        {\infer[]{\GGV K\SB \E J\SB @A}{\vdots}}

    \item \QKRefl
        
        From the induction hypothesis and \QKRefl, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QKRefl]
        {\GGV K\SB \E K\SB @A}
        {\infer[]{\GGV K\SB \iskind @A}{\vdots}}

    \item \QKSym
        
        From the induction hypothesis and \QKSym, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QKSym]
        {\GGV J\SB\E K\SB@A}
        {\GGV K\SB\E J\SB@A}

    \item \QKTrans
        
        From the induction hypothesis and \QKTrans, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QKTrans]
        {\GGV K\SB\E I\SB@A}
        {\GGV K\SB\E J\SB@A \andalso \GGV J\SB\E I\SB@A}

    \item \QTAbs
        
        From the induction hypothesis and, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QTAbs]
        {\GG \Pi x:\tau\SB.\rho\SB \E \Pi x:\sigma\SB.\pi\SB@A}
        {\ID{\GG \tau\SB \E \sigma\SB@A} \andalso \ID{\G, \D, x:\tau \V \rho\SB \E \pi\SB}}

        Arrange substitutions, 

        $\mathcal{D}'_1$ = \infer[\QTAbs]
        {\GG (\Pi x:\tau.\rho)\SB \E (\Pi x:\sigma.\pi)\SB@A}
        {\ID{\GG \tau\SB \E \sigma\SB@A} \andalso \ID{\G, \D, x:\tau \V \rho\SB \E \pi\SB}}

    \item \QTApp 
        
        From the induction hypothesis and \QTApp, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QTApp]
        {\GGV\tau\SB\ M\SB \E \sigma\SB\ N\SB@A}
        {\ID{\GGV\tau\SB\E\sigma\SB :: (\Pi x:\rho.K)@A} \andalso \ID{\GGV M\SB\E N\SB:\rho@A}}

        Arrange substitutions, 

        $\mathcal{D}'_1$ = \infer[\QTApp]
        {\GGV(\pi\ M)\SB \E (\sigma\ N)\SB@A}
        {\ID{\GGV\tau\SB\E\sigma\SB :: (\Pi x:\rho.K)@A} \andalso \ID{\GGV M\SB\E N\SB:\rho@A}}

    \item \QTTW
        
        From the induction hypothesis and \QTTW, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QTTW]
        {\GGV(\TW_\alpha \tau)\SB\E(\TW_\alpha\sigma)\SB@A}
        {\ID{\GGV\tau\SB\E\sigma\SB@A\alpha}}

    \item \QTGen
        
        We can prove easily $\alpha \notin \FTV(\GG) \cup \FTV(A)$.
        From the induction hypothesis and \QTGen, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QTGen]
        {\GGV (\forall\alpha.\tau)\SB \E (\forall\alpha.\sigma)\SB@A}
        {\ID{\GGV \tau\SB \E \sigma\SB@A} \andalso \alpha \notin \FTV(\GG) \cup \FTV(A)}

    \item \QTCsp
        
        From the induction hypothesis and \QTCsp, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QTCsp]
        {\GGV\tau\SB \E \sigma\SB@A\alpha}
        {\ID{\GGV\tau\SB \E \sigma\SB@A}}

    \item \QTRefl
        
        From the induction hypothesis and \QTRefl, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QTRefl]
        {\GGV\tau\SB\E\tau\SB@A}
        {\ID{\GGV\tau\SB::K\SB@A}}

    \item \QTSym
        
        From the induction hypothesis and \QTSym, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QTSym]
        {\GGV\sigma\SB\E\tau\SB@A}
        {\ID{\GGV\tau\SB\E\sigma\SB@A}}

    \item \QTTrans
        
        From the induction hypothesis and \QTTrans, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QTTrans]
        {\GGV \tau\SB\E\rho\SB@A}
        {\ID{\GGV\tau\SB\E\sigma\SB@A} \andalso \ID{\GGV\sigma\SB\E\rho\SB@A}}

    \item \QAbs
        
        From the induction hypothesis and \QAbs, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QAbs]
        {\GGV \Pi x:\tau\SB.\rho\SB \E \Pi x:\sigma\SB.\pi\SB@A}
        {\ID{\GGV\tau\SB \E \sigma\SB :: * @A} \andalso \ID{\GG,x:\tau\SB@A\V\rho\SB \E \pi\SB@A}}

        Arrange substitutions, 

        $\mathcal{D}'_1$ = \infer[\QAbs]
        {\GGV (\Pi x:\tau.\rho)\SB \E (\Pi x:\sigma.\pi)\SB@A}
        {\ID{\GGV\tau\SB \E \sigma\SB :: * @A} \andalso \ID{\GG,x:\tau\SB@A\V\rho\SB \E \pi\SB@A}}

    \item \QApp
        
        From the induction hypothesis

        $\mathcal{D}_1$ = \ID{\GGV M\SB \E L\SB :: (\Pi x:\sigma.\tau)\SB@A}

        Arrange substitutions, 

        $\mathcal{D}'_1$ = \ID{\GGV M\SB \E L\SB :: (\Pi x:\sigma\SB.\tau\SB)@A}
        
        Using \QApp to $\mathcal{D}'_1$ and the induction hypothesis, we get $\mathcal{D}_2$.

        $\mathcal{D}_2$ = \infer[\QApp]
        {\GGV M\SB\ N\SB \E L\SB\ O\SB @A}
        {\mathcal{D}'_1 \andalso \ID{\GGV N\SB \E O\SB : \sigma\SB @A}}

        Arrange substitutions, 

        $\mathcal{D}'_2$ = \infer[\QApp]
        {\GGV (M\ N)\SB \E (L\ O)\SB @A}
        {\mathcal{D}'_1 \andalso \ID{\GGV N\SB \E O\SB : \sigma\SB @A}}

    \item \QTB
        
        From the induction hypothesis and \QTB, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QTB]
        {\GGV\TB_\alpha M\SB \E \TB_\alpha N\SB @A}
        {\GGV M\SB \E N\SB @A\alpha}

    \item \QTBL
        
        From the induction hypothesis and \QTBL, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QTBL]
        {\GGV\TBL_\alpha M\SB \E \TBL_\alpha N\SB@A\alpha}
        {\GGV M\SB \E N\SB : \TW_\alpha \tau@A}

    \item \QGen
        
        We can prove easily $\alpha \notin \FTV(\GG) \cup \FTV(A)$.
        From the induction hypothesis and \QGen, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QGen]
        {\GGV\Lambda\alpha.M\SB \E \Lambda\alpha.N\SB@A}
        {\ID{\GGV M\SB \E N\SB @A} \andalso \alpha \notin \FTV(\GG) \cup \FTV(A)}

    \item \QIns
        
        From the induction hypothesis and \QIns, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QIns]
        {\GGV M\SB \E N\SB : \TW_\alpha.\tau @A}
        {\ID{\GGV M\SB\ \epsilon \E N\SB\ \epsilon @A }}

    \item \QCsp
        
        From the induction hypothesis and \QCsp, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QCsp]
        {\GGV \%_\alpha M\SB \E \%_\alpha N\SB @A}
        {\ID{\GGV M\SB \E N\SB @A\alpha}}

    \item \QRefl 
        
        From the induction hypothesis and \QRefl, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QRefl]
        {\GGV M\SB \E M\SB @A}
        {\ID{\GGV M\SB : \tau\SB @A}}

    \item \QSym
        
        From the induction hypothesis and \QSym, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QSym]
        {\GGV N\SB \E M\SB @A}
        {\ID{\GGV M\SB \E N\SB @A}}

    \item \QTrans
        
        From the induction hypothesis and \QTrans, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QTrans]
        {\GGV M\SB \E L\SB @A}
        {\ID{\GGV M\SB \E N\SB @A } \andalso \ID{\GGV N\SB \E L\SB @A}}

    \item \QBeta
        
        From the induction hypothesis and \QBeta, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QBeta]
        {\GGV (\lambda x:\sigma\SB:M\SB)\ N\SB \E (M\SB)[x \mapsto N\SB]@A}
        {\ID{\GG, x: \sigma\SB@A \V M\SB:\tau\SB@A} \andalso \ID{\GGV N\SB:\sigma\SB @A }}

        Arrange substitutions,

        $\mathcal{D}'_1$ = \infer[\QBeta]
        {\GGV ((\lambda x:\sigma:M)\ N)\SB \E (M[x \mapsto N])\SB@A}
        {\ID{\GG, x: \sigma\SB@A \V M\SB:\tau\SB@A} \andalso \ID{\GGV N\SB:\sigma\SB @A }}

    \item \QEta
        
        From the induction hypothesis and \QEta, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QEta]
        {\GGV (\lambda x:\sigma\SB.M\SB\ x) \E M\SB@A}
        {\ID{\GGV M\SB : (\Pi x:\sigma\SB.\tau\SB)@A} \andalso x \notin \FV(M\SB)}

        Arrange substitutions,

        $\mathcal{D}'_2$ = \infer[\QEta]
        {\GGV (\lambda x:\sigma.M\ x)\SB \E M\SB@A}
        {\ID{\GGV M\SB : (\Pi x:\sigma\SB.\tau\SB)\SB@A} \andalso x \notin \FV(M\SB)}

    \item \QTBLTB
        
        From the induction hypothesis and \QTBLTB, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QTBLTB]
        {\GGV \TBL_\alpha \TB_\alpha M\SB \E N\SB@A}
        {\ID{\GGV M\SB \E N\SB @A}}

    \item \QLambda
        
        From the induction hypothesis and \QLambda, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QLambda]
        {\GGV (\Lambda\alpha.M\SB)\ \epsilon \E M\SB[\alpha \mapsto \epsilon]}
        {\ID{\GGV (\Lambda\alpha.M\SB) : \forall\alpha.\tau\SB @A}}

        Arrange substitutions,

        $\mathcal{D}'_1$ = \infer[\QLambda]
        {\GGV ((\Lambda\alpha.M)\ \epsilon)\SB \E M[\alpha \mapsto \epsilon]\SB}
        {\ID{\GGV (\Lambda\alpha.M\SB) : \forall\alpha.\tau\SB @A}}


    \item \QPercent
        
        From the induction hypothesis and \QPercent, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QPercent]
        {\GGV \%_\alpha M\SB \E M\SB @ A\alpha}
        {\ID{\GGV M\SB : \tau\SB @A\alpha} \andalso \ID{\GGV M\SB : \sigma\SB @A} }

    \fi

\end{itemize}

\begin{thm}[Stage Substituition Lemma for Variables of Terms, Types or Kinds and Their Equivalence]
    \begin{flalign*}
        \text{If\ } \G \V M:\tau@A
        &\text{\ then\ } \G[\beta \mapsto \epsilon]\V M[\beta \mapsto \epsilon]:\tau[\beta \mapsto \epsilon]@A[\beta \mapsto \epsilon].&\\
        \text{If\ } \G \V \tau::K@A
        &\text{\ then\ } \G[\beta \mapsto \epsilon]\V \tau[\beta \mapsto \epsilon]::K[\beta \mapsto \epsilon]@A[\beta \mapsto \epsilon].&\\
        \text{If\ } \G \V K\iskind@A
        &\text{\ then\ } \G[\beta \mapsto \epsilon]\V K[\beta \mapsto \epsilon] \iskind@A[\beta \mapsto \epsilon].&\\
        \text{If\ } \G \V M\E N : \tau@A
        &\text{\ then\ } \G[\beta \mapsto \epsilon]\V M[\beta \mapsto \epsilon]\E N[\beta \mapsto \epsilon] : \tau[\beta \mapsto \epsilon] @A[\beta \mapsto \epsilon].&\\
        \text{If\ } \G \V \tau\E \sigma : K@A
        &\text{\ then\ } \G[\beta \mapsto \epsilon]\V \tau[\beta \mapsto \epsilon]\E \sigma[\beta \mapsto \epsilon] : K[\beta \mapsto \epsilon]@A[\beta \mapsto \epsilon].&\\
        \text{If\ } \G \V K\E J@A
        &\text{\ then\ } \G[\beta \mapsto \epsilon]\V K[\beta \mapsto \epsilon]\E J[\beta \mapsto \epsilon]@A[\beta \mapsto \epsilon].&
    \end{flalign*}
\end{thm}

\begin{itemize}

    \newcommand{\SB}{[\beta \mapsto \epsilon]}
    \newcommand{\GG}{\G\SB}
    \newcommand{\GGV}{\G\SB \V}

    \iffullversion

    \item \WStar
    
        From the definition of \WStar, we can get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\WStar]
        {\GGV * \iskind @A\SB}
        {}

    \item \WAbs
    
        From the induction hypothesis and \WAbs, we get $\mathcal{D}_1$.
    
        $\mathcal{D}_1$ = \infer[\WAbs]
        {\GGV (\Pi x:\tau.K)\SB \iskind @A}
        {
            \ID{\GGV \tau\SB::*@A\SB} \andalso 
            \ID{\GG, x:\tau\SB \V K\SB \iskind@}
        }

    \item \WCsp
    
        \begin{itemize}

            \item $\alpha \neq \beta$

                 From the induction hypothesis and \WCsp, we can get $\mathcal{D}_1$.

                $\mathcal{D}_1$ = \infer[\WCsp]
                {\GGV K\SB \iskind @A\alpha\SB}
                {\ID{\GGV K\SB \iskind @A\SB}}

            \item $\alpha = \beta$
            
                The conclusion is identical with the induction hypothesis.

        \end{itemize}
    
    \item \WTW
    
        \begin{itemize}

            \item $\alpha \neq \beta$
    
                From the induction hypothesis and \WTW, we can get $\mathcal{D}_1$.

                $\mathcal{D}_1$ = \infer[\WTW]
                {\GGV K\SB \iskind @A\SB}
                {\ID{\GGV K\SB \iskind @A\alpha\SB}}

            \item $\alpha = \beta$
            
                The conclusion is identical with the induction hypothesis.

        \end{itemize}
  
    \item \KVar

        We can easily show that $X::K\SB \in \GG$.
        From the induction hypothesis and \KVar, we can get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\KVar]
        {\GGV X :: K\SB @A\SB}
        {X::K\SB \in \GG \andalso \ID{\GGV K\SB \iskind @A\SB}}

    \item \KAbs
    
        From the induction hypothesis, we can get $\mathcal{D}_1$ and $\mathcal{D}_2$.

        $\mathcal{D}_1$ = \infer[]
        {\GGV \tau\SB :: * @ A\SB}
        {\vdots}

        $\mathcal{D}_2$ = \infer[]
        {\GG, x:\tau\SB@A\V \sigma\SB::J\SB@A\SB}
        {\vdots}

        Use \KAbs,

        $\mathcal{D}_3$ = \infer[\KAbs]
        {\GGV (\Pi x:\tau\SB.\sigma\SB)::(\Pi x:\tau\SB.J\SB)@A\SB}
        {\mathcal{D}_1 \andalso \mathcal{D}_2}

        We can arrange the substitution.

        $\mathcal{D}'_3$ = \infer[\KAbs]
        {\GGV (\Pi x:\tau.\sigma)\SB::(\Pi x:\tau.J)\SB@A\SB}
        {\mathcal{D}_1 \andalso \mathcal{D}_2}

    \item \KApp
    
        From the induction hypothesis and \KApp, we can get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\KApp]
        {\GGV (\sigma\SB\ M\SB)::K\SB[x \mapsto M\SB]@A\SB}
        {\ID{\GGV \sigma\SB::(\Pi x:\tau\SB.K\SB)@A\SB} \andalso \ID{\GGV M\SB:\tau\SB@A}}

        Arrange substitutions,

        $\mathcal{D}'_1$ = \infer[\KApp]
        {\GGV (\sigma\ M)\SB::K[x \mapsto M]\SB@A\SB}
        {\ID{\GGV \sigma\SB::(\Pi x:\tau\SB.K\SB)@A\SB} \andalso \ID{\GGV M\SB:\tau\SB@A\SB}}
  
    \item \KConv
    
        From the induction hypothesis, we have $\mathcal{D}_1$ and $\mathcal{D}_2$.

        $\mathcal{D}_1$ = \infer[]
        {\GGV \tau\SB : K[z\mapsto P]@A\SB}
        {\vdots}

        $\mathcal{D}_2$ = \infer[]
        {\GGV K\SB \E J\SB @A\SB}
        {\vdots}

        Use \KConv,

        $\mathcal{D}_2$ = \infer[\KConv]
        {\GGV \tau\SB : J[z\mapsto P]@A\SB}
        {\mathcal{D}_1 \andalso \mathcal{D}_2}

    \item \KTW
    
        \begin{itemize}
            
            \item $\alpha \neq \beta$

                From the induction hypothesis, we have $\mathcal{D}_1$.

                $\mathcal{D}_1$ = \infer[]
                {\GGV \tau\SB :: K\SB @ A\alpha\SB}
                {\vdots}

                Use \KTW,

                $\mathcal{D}_2$ = \infer[]
                {\GGV \TW_\alpha \tau\SB :: K\SB @ A\SB}
                {\mathcal{D}_1}

            \item $\alpha = \beta$
            
                The conclusion is identical with the induction hypothesis.

        \end{itemize}

    \item \KTWL
     
        \begin{itemize}
            
            \item $\alpha \neq \beta$

                From the induction hypothesis, we have $\mathcal{D}_1$.

                $\mathcal{D}_1$ = \infer[]
                {\GGV \TW_\alpha \tau\SB :: K\SB @ A\alpha\SB}
                {\vdots}

                Use \KTWL,

                $\mathcal{D}_2$ = \infer[]
                {\GGV \tau\SB :: K\SB @ A\alpha\SB}
                {\mathcal{D}_1}
 
            \item $\alpha = \beta$
            
                The conclusion is identical with the induction hypothesis.

        \end{itemize}

       
    \item \KGen
    
        From the induction hypothesis, we have $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[]
        {\GGV \tau\SB :: K\SB @ A\SB}
        {\vdots}

        And we can prove easily $\alpha \notin \FTV(\GG) \cup \FTV(A)$.

        Use \KGen,

        $\mathcal{D}_2$ = \infer[\KGen]
        {\GGV \forall\alpha.\tau\SB :: K\SB @ A\SB}
        {\mathcal{D}_1 \andalso \alpha \notin \FTV(\GG) \cup \FTV(A)}

    \item \KCsp

        \begin{itemize}
            
            \item $\alpha \neq \beta$
            
                From the induction hypothesis and \KCsp, we have $\mathcal{D}_1$.

                $\mathcal{D}_1$ = \infer[\KCsp]
                {\GGV \tau\SB :: K\SB @ A\alpha\SB}
                {\ID{\GGV \tau\SB :: K\SB @ A\SB}}

            \item $\alpha = \beta$
            
                The conclusion is identical with the induction hypothesis.

        \end{itemize}

    \item \TVar
    
        We can easily prove $x:\tau\SB \in \GG$.

        From the induction hypothesis and \TVar, we have $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[]
        {\GGV x:\tau\SB @A\SB}
        {x:\tau\SB \in \GG \andalso \ID{\GGV \tau\SB::*@A\SB}}

    \item \TAbs
    
        From the induction hypothesis and \TAbs, we get

        $\mathcal{D}_1$ = \infer[\TAbs]
        {\GGV (\lambda x:\sigma\SB.M\SB):(\Pi x:\sigma\SB.\tau\SB)@A\SB}
        {\ID{\GGV \sigma\SB::*@A\SB} \andalso \ID{\GG, x:\sigma\SB@A\SB \V M\SB:\tau\SB@A\SB}}

        Arrange substitutions,

        $\mathcal{D}'_1$ = \infer[\TAbs]
        {\GGV (\lambda x:\sigma.M)\SB:(\Pi x:\sigma.\tau)\SB@A\SB}
        {\ID{\GGV \sigma\SB::*@A\SB} \andalso \ID{\GG, x:\sigma\SB@A\SB \V M\SB:\tau\SB@A\SB}}

    \item \TApp

        We have a derivation trees from the premise.
        
        $\mathcal{D}_1$ = \infer[\TApp]
        {\G, z:\xi@B, \D \V M\ L:\tau[y\mapsto L]@A}
        {\infer[]{\G, z:\xi@B, \D \V M:\Pi(y:\rho).\tau@A \andalso \G, z:\xi@B, \D \V L:\rho@A}{\vdots}}
        
        We get 2 trees from the induction hypothesis and $\mathcal{D}_1$.

        $\mathcal{D}_2$ = \infer[]
        {\GGV M\SB: (\Pi(y:\rho).\tau)\SB@A}
        {\vdots}

        and

        $\mathcal{D}_3$ = \infer[]
        {\GGV L\SB: \rho\SB@A}
        {\vdots}

        \red{distribute the substitution} in $\mathcal{D}_2$

        $\mathcal{D'}_2$ = \infer[]
        {\GGV M\SB: (\Pi(y:\rho\SB).\tau\SB)@A}
        {\vdots}

        From $\mathcal{D'}_2$ and $\mathcal{D}_3$
        
        $\mathcal{D}_4$ = \infer[\TApp]
        {\GGV (M\SB\ L\SB): \tau\SB[y \mapsto L]@A}
        {\mathcal{D'}_2 \andalso \mathcal{D}_3}

        \red{We can transform the conclusion of $\mathcal{D}_4$ into} \\
        $\GGV (M\ L)\SB: \tau[y \mapsto L]\SB@A$

    \item \TConv
    
        We have 2 derivation trees from the premise and the induction hypothesis.

        $\mathcal{D}_1$ = \infer[]
        {\GGV t\SB:T\SB@A}
        {\vdots}

        $\mathcal{D}_2$ = \infer[]
        {\GGV T\SB \E T'\SB@A}
        {\vdots}

        And then \\
        \infer[\TConv]
        {\GGV t\SB:T'\SB@A}
        {\mathcal{D}_1 \andalso \mathcal{D}_2}

    \item \TTB

        \begin{itemize}
            
            \item $\alpha \neq \beta$
                From the induction hypothesis and \TTB, we get
        
                $\mathcal{D}_1$ = \infer[\TTB]
                {\GGV \TB_\alpha M\SB:\tau\SB@A\SB}
                {\infer[]{\GGV M\SB:\tau\SB@A\alpha\SB}{\vdots}}    

            \item $\alpha = \beta$
            
                The conclusion is identical with the induction hypothesis.

        \end{itemize}

    \item \TTBL

        \begin{itemize}
            
            \item $\alpha \neq \beta$
                From the induction hypothesis and \TTBL, we get
        
                $\mathcal{D}_3$ = \infer[\TTBL]
                {\GGV \TBL_\alpha M\SB:\tau\SB@A\SB}
                {
                    \infer[]{\GGV M\SB: \TW_\alpha \tau\SB@A\alpha\SB}{\vdots}
                }

            \item $\alpha = \beta$
            
                The conclusion is identical with the induction hypothesis.

        \end{itemize}

    \item \TGen
    
        From the induction hypothesis, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[]
        {\GGV M\SB:\tau\SB@A\SB}
        {\vdots}

        And we can prove easily $\alpha \notin \FTV(\GG) \cup \FTV(A)$.

        Use \TGen,

        $\mathcal{D}_2$ = \infer[\TGen]
        {\GGV (\Lambda\alpha.M)\SB:(\forall\alpha.\tau)\SB@A\SB}
        {\mathcal{D}_1 \andalso \alpha \notin \FTV(\GG) \cup \FTV(A)}

    \item \TIns
    
        We can assume $\alpha \neq \beta$ because $\alpha$ appears only in $M:\forall\alpha.\tau$ and we can rename $\alpha$ to an arbitary name.
    
        From the induction hypothesis and \TIns, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\TIns]
        {\GGV (M\ \epsilon)\SB:\tau\SB@A\SB}
        {\ID{\GGV M\SB:(\forall\alpha.\tau)\SB@A\SB}}

    \item \TCsp
    
         \begin{itemize}
            
            \item $\alpha \neq \beta$
             
                From the induction hypothesis and \TCsp, we get $\mathcal{D}_1$.

                $\mathcal{D}_2$ = \infer[\TCsp]
                {\GGV (\%_\alpha M)\SB:\tau\SB@A\alpha}
                {\ID{\GGV M\SB:\tau\SB@A}}

            \item $\alpha = \beta$
            
                The conclusion is identical with the induction hypothesis.

        \end{itemize}

    \item \QKAbs
        
        From the induction hypothesis and \QKAbs, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QKAbs]
        {\GGV (\Pi x:\tau.K)\SB \E (\Pi x:\sigma.J)\SB@A\SB}
        {\infer[]{\GGV \tau\SB \E \sigma\SB :: *@A\SB}{\vdots} \andalso 
        \infer[]{\GG,x:\tau@A \V K\SB\E J\SB@A\SB}{\vdots} }

    \item \QKCsp
    
        \begin{itemize}
            
            \item $\alpha \neq \beta$
            
                From the induction hypothesis and \QKCsp, we get $\mathcal{D}_1$.

                $\mathcal{D}_1$ = \infer[\QKCsp]
                {\GGV K\SB \E J\SB @A\alpha\SB}
                {\infer[]{\GGV K\SB \E J\SB @A\SB}{\vdots}}

           
            \item $\alpha = \beta$
            
                The conclusion is identical with the induction hypothesis.

        \end{itemize}        

    \item \QKRefl
        
        From the induction hypothesis and \QKRefl, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QKRefl]
        {\GGV K\SB \E K\SB @A\SB}
        {\infer[]{\GGV K\SB \iskind @A\SB}{\vdots}}

    \item \QKSym
        
        From the induction hypothesis and \QKSym, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QKSym]
        {\GGV J\SB\E K\SB@A\SB}
        {\GGV K\SB\E J\SB@A\SB}

    \item \QKTrans
        
        From the induction hypothesis and \QKTrans, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QKTrans]
        {\GGV K\SB\E I\SB@A\SB}
        {\GGV K\SB\E J\SB@A\SB \andalso \GGV J\SB\E I\SB@A\SB}

    \item \QTAbs
        
        From the induction hypothesis and, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QTAbs]
        {\GGV \Pi x:\tau\SB.\rho\SB \E \Pi x:\sigma\SB.\pi\SB@A\SB}
        {\ID{\GGV \tau\SB \E \sigma\SB :: *@A\SB} \andalso \ID{\GG, x:\tau\SB@A\SB \V \rho\SB \E \pi\SB @A\SB}}

        Arrange substitutions, 

        $\mathcal{D}_1$ = \infer[\QTAbs]
        {\GGV (\Pi x:\tau.\rho)\SB \E (\Pi x:\sigma.\pi)\SB@A\SB}
        {\ID{\GGV \tau\SB \E \sigma\SB :: *@A\SB} \andalso \ID{\GG, x:\tau\SB@A\SB \V \rho\SB \E \pi\SB @A\SB}}

    \item \QTApp 
        
        From the induction hypothesis and \QTApp, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QTApp]
        {\GGV\pi\SB\ M\SB \E \sigma\SB\ N\SB@A\SB}
        {\ID{\GGV\tau\SB\E\sigma\SB :: (\Pi x:\rho\SB.K\SB)@A\SB} \andalso \ID{\GGV M\SB\E N\SB:\rho\SB@A\SB}}

        Arrange substitutions, 

        $\mathcal{D}_1$ = \infer[\QTApp]
        {\GGV(\pi\ M)\SB \E (\sigma\ N)\SB@A\SB}
        {\ID{\GGV\tau\SB\E\sigma\SB :: (\Pi x:\rho\SB.K\SB)@A\SB} \andalso \ID{\GGV M\SB\E N\SB:\rho\SB@A\SB}}

    \item \QTTW
    
        \begin{itemize}
            
            \item $\alpha \neq \beta$
            
                From the induction hypothesis and \QTTW, we get $\mathcal{D}_1$.

                $\mathcal{D}_1$ = \infer[\QTTW]
                {\GGV(\TW_\alpha \tau)\SB\E(\TW_\alpha\sigma)\SB@A\SB}
                {\ID{\GGV\tau\SB\E\sigma\SB@A\alpha\SB}}
           
            \item $\alpha = \beta$
            
                The conclusion is identical with the induction hypothesis.

        \end{itemize}        
        
    \item \QTGen
        
        We can assume $\alpha \neq \beta$ because $\alpha$ appears only in $M:\forall\alpha.\tau$ and we can rename $\alpha$ to an arbitary name.

        We can prove easily $\alpha \notin \FTV(\GG) \cup \FTV(A)$.
        From the induction hypothesis and \QTGen, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QTGen]
        {\GGV (\forall\alpha.\tau)\SB \E (\forall\alpha.\sigma)\SB@A\SB}
        {\ID{\GGV \tau\SB \E \sigma\SB@A\SB} \andalso \alpha \notin \FTV(\GG) \cup \FTV(A)}

    \item \QTCsp

        \begin{itemize}
            
            \item $\alpha \neq \beta$
 
        From the induction hypothesis and \QTCsp, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QTCsp]
        {\GGV\tau\SB \E \sigma\SB@A\alpha\SB}
        {\ID{\GGV\tau\SB \E \sigma\SB@A\SB}}
           
            \item $\alpha = \beta$
            
                The conclusion is identical with the induction hypothesis.

        \end{itemize}        

    \item \QTRefl
        
        From the induction hypothesis and \QTRefl, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QTRefl]
        {\GGV\tau\SB\E\tau\SB@A\SB}
        {\ID{\GGV\tau\SB::K\SB@A\SB}}

    \item \QTSym
        
        From the induction hypothesis and \QTSym, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QTSym]
        {\GGV\sigma\SB\E\tau\SB@A\SB}
        {\ID{\GGV\tau\SB\E\sigma\SB@A\SB}}

    \item \QTTrans
        
        From the induction hypothesis and \QTTrans, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QTTrans]
        {\GGV \tau\SB\E\rho\SB@A\SB}
        {\ID{\GGV\tau\SB\E\sigma\SB@A\SB} \andalso \ID{\GGV\sigma\SB\E\rho\SB@A\SB}}

    \item \QAbs
        
        From the induction hypothesis and \QAbs, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QAbs]
        {\GGV \Pi x:\tau\SB.\rho\SB \E \Pi x:\sigma\SB.\pi\SB@A\SB}
        {\ID{\GGV\tau\SB \E \sigma\SB :: * @A\SB} \andalso \ID{\GG,x:\tau\SB@A\SB\V\rho\SB \E \pi\SB@A\SB}}

        Arrange substitutions, 

        $\mathcal{D}'_1$ = \infer[\QAbs]
        {\GGV (\Pi x:\tau.\rho)\SB \E (\Pi x:\sigma.\pi)\SB@A\SB}
        {\ID{\GGV\tau\SB \E \sigma\SB :: * @A\SB} \andalso \ID{\GG,x:\tau\SB@A\SB\V\rho\SB \E \pi\SB@A\SB}}

    \item \QApp
        
        From the induction hypothesis

        $\mathcal{D}_1$ = \ID{\GGV M\SB \E L\SB :: (\Pi x:\sigma.\tau)\SB@A\SB}

        Arrange substitutions, 

        $\mathcal{D}'_1$ = \ID{\GGV M\SB \E L\SB :: (\Pi x:\sigma\SB.\tau\SB)@A\SB}
        
        Using \QApp\ to $\mathcal{D}'_1$ and the induction hypothesis, we get $\mathcal{D}_2$.

        $\mathcal{D}_2$ = \infer[\QApp]
        {\GGV M\SB\ N\SB \E L\SB\ O\SB @A\SB}
        {\mathcal{D}'_1 \andalso \ID{\GGV N\SB \E O\SB : \sigma\SB @A\SB}}

        Arrange substitutions, 

        $\mathcal{D}'_2$ = \infer[\QApp]
        {\GGV (M\ N)\SB \E (L\ O)\SB @A\SB}
        {\mathcal{D}'_1 \andalso \ID{\GGV N\SB \E O\SB : \sigma\SB @A\SB}}

    \item \QTB
        
        \begin{itemize}
            
            \item $\alpha \neq \beta$
 
                From the induction hypothesis and \QTB, we get $\mathcal{D}_1$.

                $\mathcal{D}_1$ = \infer[\QTB]
                {\GGV\TB_\alpha M\SB \E \TB_\alpha N\SB @A\SB}
                {\GGV M\SB \E N\SB @A\alpha\SB}
           
            \item $\alpha = \beta$
            
                The conclusion is identical with the induction hypothesis.

        \end{itemize}        

    \item \QTBL
    
        \begin{itemize}
            
            \item $\alpha \neq \beta$
                    
                From the induction hypothesis and \QTBL, we get $\mathcal{D}_1$.

                $\mathcal{D}_1$ = \infer[\QTBL]
                {\GGV\TBL_\alpha M\SB \E \TBL_\alpha N\SB@A\alpha\SB}
                {\GGV M\SB \E N\SB : \TW_\alpha \tau@A\SB}
            
            \item $\alpha = \beta$
            
                The conclusion is identical with the induction hypothesis.

        \end{itemize}        

    \item \QGen
            
        \begin{itemize}
            
            \item $\alpha \neq \beta$

                We can prove easily $\alpha \notin \FTV(\GG) \cup \FTV(A)$.
                From the induction hypothesis and \QGen, we get $\mathcal{D}_1$.

                $\mathcal{D}_1$ = \infer[\QGen]
                {\GGV\Lambda\alpha.M\SB \E \Lambda\alpha.N\SB@A\SB}
                {\ID{\GGV M\SB \E N\SB @A\SB} \andalso \alpha \notin \FTV(\GG) \cup \FTV(A)}
           
            \item $\alpha = \beta$
            
                The conclusion is identical with the induction hypothesis.

        \end{itemize}        

    \item \QIns
        
        We can assume $\alpha \neq \beta$ because $\alpha$ appears only in $M:\forall\alpha.\tau$ and we can rename $\alpha$ to an arbitary name.

        From the induction hypothesis and \QIns, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QIns]
        {\GGV M\SB\ \epsilon \E N\SB \ \epsilon @A\SB }
        {\ID{\GGV M\SB \E N\SB : (\forall\alpha.\tau\SB) @A\SB}}

    \item \QCsp
           
        \begin{itemize}
            
            \item $\alpha \neq \beta$
            
                From the induction hypothesis and \QCsp, we get $\mathcal{D}_1$.

                $\mathcal{D}_1$ = \infer[\QCsp]
                {\GGV \%_\alpha M\SB \E \%_\alpha N\SB @A\SB}
                {\ID{\GGV M\SB \E N\SB @A\alpha\SB}}
           
            \item $\alpha = \beta$
            
                The conclusion is identical with the induction hypothesis.

        \end{itemize}        
 
    \item \QRefl 
        
        From the induction hypothesis and \QRefl, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QRefl]
        {\GGV M\SB \E M\SB @A\SB}
        {\ID{\GGV M\SB : \tau\SB @A\SB}}

    \item \QSym
        
        From the induction hypothesis and \QSym, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QSym]
        {\GGV N\SB \E M\SB @A\SB}
        {\ID{\GGV M\SB \E N\SB @A\SB}}

    \item \QTrans
        
        From the induction hypothesis and \QTrans, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QTrans]
        {\GGV M\SB \E L\SB @A\SB}
        {\ID{\GGV M\SB \E N\SB @A\SB } \andalso \ID{\GGV N\SB \E L\SB @A\SB}}

    \item \QBeta
        
        From the induction hypothesis and \QBeta, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QBeta]
        {\GGV (\lambda x:\sigma\SB:M\SB)\ N\SB \E (M\SB)[x \mapsto N\SB]@A\SB}
        {\ID{\GG, x: \sigma\SB@A\SB \V M\SB:\tau\SB@A\SB} \andalso \ID{\GGV N\SB:\sigma\SB @A\SB }}

        Arrange substitutions,

        $\mathcal{D}'_1$ = \infer[\QBeta]
        {\GGV ((\lambda x:\sigma:M)\ N)\SB \E (M[x \mapsto N])\SB@A\SB}
        {\ID{\GG, x: \sigma\SB@A\SB \V M\SB:\tau\SB@A\SB} \andalso \ID{\GGV N\SB:\sigma\SB @A\SB }}

    \item \QEta
        
        From the induction hypothesis and \QEta, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QEta]
        {\GGV (\lambda x:\sigma\SB.M\SB\ x) \E M\SB@A\SB}
        {\ID{\GGV M\SB : (\Pi x:\sigma\SB.\tau\SB)@A\SB} \andalso x \notin \FV(M\SB)}

        Arrange substitutions,

        $\mathcal{D}'_2$ = \infer[\QEta]
        {\GGV (\lambda x:\sigma.M\ x)\SB \E M\SB@A\SB}
        {\ID{\GGV M\SB : (\Pi x:\sigma\SB.\tau\SB)\SB@A\SB} \andalso x \notin \FV(M\SB)}

    \item \QTBLTB
        
        From the induction hypothesis and \QTBLTB, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QTBLTB]
        {\GGV \TBL_\alpha \TB_\alpha M\SB \E N\SB@A\SB}
        {\ID{\GGV M\SB \E N\SB @A\SB}}

    \item \QLambda
        
        From the induction hypothesis and \QLambda, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QLambda]
        {\GGV (\Lambda\alpha.M\SB)\ \epsilon \E M\SB[\alpha \mapsto \epsilon]}
        {\ID{\GGV (\Lambda\alpha.M\SB) : \forall\alpha.\tau\SB @A\SB}}

        Arrange substitutions,

        $\mathcal{D}'_1$ = \infer[\QLambda]
        {\GGV ((\Lambda\alpha.M)\ \epsilon)\SB \E M[\alpha \mapsto \epsilon]\SB}
        {\ID{\GGV (\Lambda\alpha.M\SB) : \forall\alpha.\tau\SB @A\SB}}


    \fi

    \item \QPercent
        
        From the induction hypothesis and \QPercent, we get $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\QPercent]
        {\GGV \%_\alpha M\SB \E M\SB @ A\alpha}
        {\ID{\GGV M\SB : \tau\SB @A\alpha\SB} \andalso \ID{\GGV M\SB : \sigma\SB @A\SB} }
    
\end{itemize}

\begin{thm}[Agreement]
    \begin{flalign*}
        \text{If\ } \G\V \tau::K@A &\text{\ then\ } \G\V K\iskind@A. &\\
        \text{If\ } \G\V M:\tau@A &\text{\ then\ } \G\V \tau::*@A.&\\
        \text{If\ } \G\V K\E J@A &\text{\ then\ } \G\V K\iskind@A \text{\ and\ } \G\V J\iskind@A.&\\
        \text{If\ } \G\V \tau\E \sigma :: K@A &\text{\ then\ } \G\V \tau::K@A \text{\ and\ } \G\V \sigma::K@A.&\\
        \text{If\ } \G\V M\E N : \tau@A &\text{\ then\ } \G\V M:\tau@A \text{\ and\ } \G\V N:\tau@A.&\\
    \end{flalign*}
\end{thm}

We can prove using induction on the derivation tree. 

Basecases are \KVar, \TVar, \QKRefl, \QTRefl, \QRefl.
We can prove for these cases directly from the definition of rules.

Others are proved by using induction hypothesis and a rule. We show some cases as examples.
\begin{itemize}
    \item \KCsp
    
        We have a derivation tree from the premise.

        $\mathcal{D}_1$ = \infer[\KCsp]
        {\G\V \tau::K@A\alpha}
        {\infer[]{\G\V \tau::K @A}{\vdots}}

        From the hypothesis of the reduction, we can get

        $\mathcal{D}_2$ = \infer[]{\G\V K\iskind @A}{\vdots}

        Use \WCsp\ to $\mathcal{D}_2$, we get the conclusion.

        $\mathcal{D}_3$ = \infer[\WCsp]
        {\G\V K \iskind @A\alpha}
        {\mathcal{D}_2}

    \item \KTW
    
        We have a derivation tree from the premise.
    
        $\MD{1}$ = \infer[\KTW]
        {\G\V\TW_\alpha \tau::*@A}
        {\vdots}

        From \WStar, $\G\V * \iskind @A$.

\end{itemize}

\begin{thm}[Inversion Lemma for $\Pi$ type]
    If $\G \V (\lambda x:\sigma.M) : (\Pi x:\sigma'.\tau)@A$ then
    \begin{enumerate}
        \item $\G \V \sigma \E \sigma'@A$
        \item $\G ,x:\sigma@A\V M:\tau@A$
    \end{enumerate}
    \item If $\G \V \rho \E (\Pi x:\sigma.\tau) : K @A$ then $\exists \sigma', \tau', K, J$ such that
    \begin{enumerate}
        \item $\rho = \Pi x:\sigma'.\tau'$
        \item $\G \V \sigma \E \sigma' : K @A$
        \item $\G, x:\sigma@A\V \tau \E \tau' : J @A$
    \end{enumerate}
    \item If $\G \V (\Pi x:\sigma.\tau) \E \rho : K @A$ then $\exists \sigma', \tau', K, J$ such that
    \begin{enumerate}
        \item $\rho = \Pi x:\sigma'.\tau'$
        \item $\G \V \sigma \E \sigma' : K @A$
        \item $\G, x:\sigma@A\V \tau \E \tau' : J @A$
    \end{enumerate}
\end{thm}

Proved by induction on the derivation tree.

\begin{itemize}
    \item \TAbs
    
        We have a derivation tree $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\TAbs]
        {\G \V ((\lambda x:\sigma).M) : (\Pi (x:\sigma).\tau) @ A}
        {\ID{\G \V \sigma :: * @ A} \andalso \ID{\G, x:\sigma@A \V M:\tau@A}}

        Following conclusion are obvious.
        \begin{enumerate}
            \item $\G \V \sigma \E \sigma'@A$
            \item $\G ,x:\sigma@A\V M:\tau@A$
        \end{enumerate}
    
    \item \TConv
    
        We have a derivation tree $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\TConv]
        {\G \V M : (\Pi x:\sigma.\tau)@A}
        {\ID{\G \V M : \rho@A } \andalso \ID{\G \V \rho \E (\Pi x:\sigma.\tau)@A}}

        Now, we can use the induction hypothesis to $\G \V M : \rho@A$ and $\G \V \rho \E (\Pi x:\sigma.\tau)@A$.
       
    \item \QTRefl
   
        There two cases for the conclusion.
        \begin{itemize}
            \item $\G \V \rho \E (\Pi x:\sigma.\tau) : K @A$
            
                In this case, we can use the induction hypothesis of statement 3.
            \item $\G \V (\Pi x:\sigma.\tau) \E \rho : K @A$
            
                In this case, we can use the induction hypothesis of statement 2.
        \end{itemize}

    \item Otherwise
    
        It is obvious.

\end{itemize}

\begin{thm}[Preservation for term on $\beta$ reduction]
    If $\G\V M:\tau@A$ and $M \longrightarrow_{\beta} M'$, then $\G\V M':\tau@A$\\
\end{thm}

Use induction on type derivation tree. 

\begin{itemize}
    \newcommand{\LB}{\longrightarrow_{\beta}}

    \item \TApp

        We can assume the reduction has following shape.

        \begin{itemize}
            \item $(\lambda x:\sigma.N)\ L \LB N[x\mapsto L]$
            
                Because the last rule is \TApp, we have $\mathcal{D}_1$.

                $\mathcal{D}_1$ = \infer[\TApp]
                {\G \V (\lambda x:\sigma.N)\ L : \tau[x\mapsto N]@A}
                {\ID{\G \V (\lambda x:\sigma.N) : (\Pi x:\sigma'.\tau')@A} \andalso \ID{\G \V L:\sigma' @A}} \\

                Use "Inversion Lemma for $\Pi$ type" to $\G \V (\lambda x:\sigma.N) : (\Pi x:\sigma'.\tau')@A$,\\
                get $\G, x:\sigma \V N:\tau$ and $\G \V \sigma \E \sigma'$ and $\G ,x:\sigma \V \tau \E \tau'@A$.

                Use \TConv, $\G \V L:\sigma @A$.

                Use "Substituition Lemma" to $\G, x:\sigma \V N:\tau$ and $\G \V L:\sigma @A$, get $\G \V N[x\mapsto L]:\tau[x\mapsto L]$.
                %Get $\G \V \tau

            \item $M\ N \LB M'\ N$
            
                From the induction hypothesis and \TApp, the type is preserved for the reduction.
            \item $M\ N \LB M\ N'$
            
                From the induction hypothesis and \TApp, the type is preserved for the reduction.
        \end{itemize}

    \iffullversion

    \item \TVar
    
        In this case, there is no reduction from $x$.

    \item \TAbs
    
        We can assume the reduction has following shape.
        
        $\lambda x:\sigma.M \LB \lambda x:\sigma.M'$

        From the induction hypothesis and \TAbs, the type is preserved for the reduction.


    \item \TConv
    
        We can assume the reduction has following shape.
        
        $M \LB M'$

        From the induction hypothesis and \TConv, the type is preserved for the reduction.

    \item \TTB
    
        We can assume the reduction has following shape.
        
        $\TB M \LB \TB M'$

        From the induction hypothesis and \TTB, the type is preserved for the reduction.

    \item \TTBL
    
        We can assume the reduction has following shape.
        
        $\TBL M \LB \TBL M'$

        From the induction hypothesis and \TTBL, the type is preserved for the reduction.

    \item \TGen
    
        We can assume the reduction has following shape.
        
        $\Lambda\alpha. M \LB \Lambda\alpha. M'$

        From the induction hypothesis and \TGen, the type is preserved for the reduction.

    \item \TIns
    
        We can assume the reduction has following shape.
        
        $M\ \epsilon \LB M'\ \epsilon$

        From the induction hypothesis and \TIns, the type is preserved for the reduction.

    \item \TCsp
 
        We can assume the reduction has following shape.
        
        $\%_\alpha M \LB \%_\alpha M'$

        From the induction hypothesis and \TCsp, the type is preserved for the reduction.

    \fi

\end{itemize}

\begin{thm}[Inversion Lemma for $\TW$ type]
    \begin{item}
    \item If $\G \V \TB_\alpha M : \TW_\alpha \tau@A$ then $\G \V M : \tau @A$.
   \item If $\G \V \rho \E  \TW_\alpha \tau : K @A$ then $\exists \tau', K, J$ such that
    \begin{enumerate}
        \item $\rho = \TW_\alpha \tau'$
        \item $\G @A\V \tau \E \tau' : K @A$
    \end{enumerate}
    \item If $\G \V \TW_\alpha \tau \E \rho : K @A$ then $\exists \tau', K, J$ such that
    \begin{enumerate}
        \item $\rho = \TW_\alpha \tau'$
        \item $\G @A\V \tau \E \tau' : K @A$
    \end{enumerate}
    \end{item}
\end{thm}

\begin{itemize}
    \item \TTB
    
        The derivation tree looks like $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\TTB]
        {\G \V \TB_\alpha M : \TW_\alpha \tau@A}
        {\ID{\G \V M : \tau@A\alpha}}

    \item Otherwise

        It is obvious.

\end{itemize}

\begin{thm}[Preservation for term on $\TBL\TB$ reduction]
    If $\G\V M:\tau@A$ and $M\longrightarrow_\blacklozenge N$, then $\G\V N:\tau@A$\\
\end{thm}

Use induction on type derivation tree. 

\begin{itemize}
    \newcommand{\R}{\longrightarrow_{\blacklozenge}}

    \item \TTBL

        There are 2 cases for $\R$.

        \begin{itemize}
            \item $\TBL\TB M \R M$
            
                Because the last rule is \TTBL, we have $\mathcal{D}_1$.

                $\mathcal{D}_1$ = \infer[\TTBL]
                {\G \V \TBL\TB M : \tau@A}
                {\ID{\G \V \TB M : \TW_\alpha \tau @A}}

                Use "Inversion Lemma for $\TW$ type" to $\G \V \TB M : \TW_\alpha \tau @A$,  get $\G \V M : \tau @A$

            \item $\TBL M \R \TBL M'$
            
                We can use the induction hypothesis directly.
        \end{itemize}

   \item Otherwise

        We can use the induction hypothesis directly.
\end{itemize}

\begin{thm}[Inversion Lemma for $\Lambda$ type]
    \begin{item}
    \item If $\G \V \Lambda\alpha.M : \forall\alpha.\tau@A$ then $\G \V M : \tau @A$ and $\alpha \notin \FTV(\G) \cup \FV(A)$.
    \item If $\G \V \rho \E \forall\alpha.\tau : K @A$ then $\exists \tau', K$ such that
    \begin{enumerate}
        \item $\rho = \forall\alpha.\tau'$
        \item $\G \V \tau \E \tau' : K @A$
    \end{enumerate}
    \item If $\G \V \forall\alpha.\tau \E \rho : K @A$ then $\exists \tau', K$ such that
    \begin{enumerate}
        \item $\rho = \forall\alpha.\tau'$
        \item $\G \V \tau \E \tau' : K @A$
    \end{enumerate}
    \end{item}
\end{thm}

\begin{itemize}
    \newcommand{\MC}[1]{\mathcal{#1}}
    \item \TGen
    
        The derivation tree is $\MC{D}_1$.

        $\MC{D}_1$ = \infer[\TGen]
        {\G \V \Lambda\alpha.M : \forall\alpha.\tau@A}
        {\ID{\G\V M:\tau@A} \andalso \alpha \notin \FTV(\G)\cup\FTV(A)}

    \item Otherwise

        It is obvious.
\end{itemize}

\begin{thm}[Preservation for term on $\Lambda$ reduction]
    If $\G\V M:\tau@A$ and $M \longrightarrow_{\Lambda} N$, then $\G\V N:\tau@A$.
\end{thm}

Use induction on type derivation tree. 

\begin{itemize}
    \newcommand{\R}{\longrightarrow_{\Lambda}}
    \item \TIns
    
        There are two cases for the reduction.
        \begin{itemize}
            \item $\Lambda\alpha.M\ \epsilon \R M[\alpha \mapsto \epsilon]$
            
                The type derivation tree looks like $\mathcal{D}_1$.

                $\mathcal{D}_1$ = \infer[\TIns]
                {\G \V \Lambda\alpha.M\ \epsilon : \tau[\alpha \mapsto \epsilon] @ A}
                {\ID{\G \V \Lambda\alpha.M\ : \forall\alpha.\tau @ A}}

                Use "Inversion Lemma for $\Lambda$ type" to $\G \V \Lambda\alpha.M\ : \forall\alpha.\tau @ A$,
                get $\G \V M : \tau @ A$ and $\alpha \notin \FTV(\G) \cup \FV(A)$.

                Use "Stage Substituition Lemma" to $\G \V M : \tau @ A$,
                get $\G[\alpha \mapsto \epsilon] \V M[\alpha \mapsto \epsilon] : \tau[\alpha \mapsto \epsilon] @ A[\alpha \mapsto \epsilon]$.

                Because $\alpha \notin \FTV(\G) \cup \FV(A)$, $\G[\alpha \mapsto \epsilon] = \G$ and $A[\alpha \mapsto \epsilon] = A$.

                So, we can rewrite $\G[\alpha \mapsto \epsilon] \V M[\alpha \mapsto \epsilon] : \tau[\alpha \mapsto \epsilon] @ A[\alpha \mapsto \epsilon]$ to
                $\G \V M[\alpha \mapsto \epsilon] : \tau[\alpha \mapsto \epsilon] @ A$.
            \item $M\ \epsilon \R M'\ \epsilon$
            
                We can use induction hypothesis directly.
        \end{itemize}

    \item Otherwise
    
        we can use induction hypothesis directly.
\end{itemize}

\begin{dfn}[$\natural$ translation]
    $\natural$ translation is a translation from $\lambda^\text{MD}$ to $\lambda^\to$.
    \begin{itemize}
    \item Term
        \begin{flalign*}
            \natural(x) &= x & \\
            \natural(\lambda x:\tau.M) &= \lambda x:\natural(\tau).\natural(M) & \\
            \natural(M\ N) &= \natural(M)\ \natural(N)& \\
            \natural(\TB_\alpha M) &= \natural(M) & \\
            \natural(\TBL_\alpha M) &= \natural(M)& \\
            \natural(\Lambda\alpha.M) &= \natural(M)& \\
            \natural(M\ \epsilon) &= \natural(M) &
        \end{flalign*}
    \item Type
    \begin{flalign*}
        \natural(X) &= X & \\
        \natural(\Pi x:\tau.\sigma) &= \natural(\tau) \to \natural(\sigma) & \\
        \natural(\tau\ x) &= \natural(\tau) & \\
        \natural(\TW_\alpha \tau) &= \natural(\tau) & \\
        \natural(\forall \alpha.\tau) &= \natural(\tau) &
    \end{flalign*}
    \item Kind
        \begin{flalign*}
            \natural(K) &= * &
        \end{flalign*}
    \item Context
        \begin{flalign*}
            \natural(\phi) &= \phi & \\
            \natural(\G, x:T@A) &= \natural(\G), \natural(x):\natural(\tau) & \\
            \natural(\G, X:K@A) &= \natural(\G) &
        \end{flalign*}
\end{itemize}
\end{dfn}

\begin{thm}[Preservation of equality in $\natural$]
    If $\G \V \tau \E \sigma @ A$ then $\natural(\tau) = \natural(\sigma)$.
\end{thm}

Prove by induction on the derivation tree.

\begin{thm}[Preservation of typing in $\natural$]
    If $\G \V M:\tau@A$ in $\lambda^{\text{MD}}$ then $\natural(\G) \V \natural(M): \natural(\tau)$ in $\lambda^\to$.
\end{thm}

Prove by induction on the type derivation tree.

\begin{itemize}
    \item \TApp
    
        We have a derivation tree $\MD{1}$.

        $\MD{1}$ = \infer[\TApp]
        {\G \V M N : \tau[x \mapsto N] @A}
        {\ID{\G \V M : (\Pi(x:\sigma).\tau) @ A} \andalso \ID{\G \V N :\sigma @A}}

        From the induction hypothesis, we have $\natural(\G) \V \natural(M) : \natural(\sigma) \to \natural(\tau)$ and $\natural(\G) \V \natural(N) : \natural(\sigma)$.
        Use the Application rule in $\lambda^\to$, we get $\natural(\G) \V \natural(M)\ \natural(N) : \natural(\tau)$.
        Because $\natural(M)\ \natural(N) = \natural(M\ N)$ from the definition of $\natural$, $\natural(\G) \V \natural(M\ N) : \natural(\tau)$ in $\lambda^\to$.
    \item \TConv
    
        We have a derivation tree $\MD{1}$.

        $\MD{1}$ = \infer[\TConv]
        {\G\V M:\sigma@A}
        {\ID{\G\V M:\tau@A} \andalso \ID{\G\V \tau\E\sigma@A}}

        Use "Preservation of typing in $\natural$" to $\G\V \tau\E\sigma@A$, we get $\natural(\tau) = \natural(\sigma)$. 
        On the otherhand, $\natural(\G) \V \natural(M):\natural(\tau)$ from the induction hypothesis.
        Then $\natural(\G) \V \natural(M):\natural(\sigma)$.

\end{itemize}

\begin{thm}[Inversion Lemma for Application]
    \begin{item}
        \item If $\G \V (\lambda x:\sigma.M)\ N: \tau@A$ then $\exists x, \rho$ such that
        \begin{enumerate}
            \item $\G, x:\sigma \V M : \rho @A$
            \item $\G \V N:\sigma @ A$
        \end{enumerate}
   \end{item}
\end{thm}

Prove by induction on the derivation tree.

\begin{itemize}
    \item \TApp 
    
        Obvious.

    \item \TConv
    
        The derivation is $\mathcal{D}_1$.

        $\mathcal{D}_1$ = \infer[\TConv]
        {\G \V (\lambda x:\sigma.M)\ N: \tau@A}
        {\ID{\G \V (\lambda x:\sigma.M)\ N: \rho@A} \andalso \ID{\G \V \rho \E \tau : K @A}}

        Use the induction hypothesis to $\G \V (\lambda x:\sigma.M)\ N: \rho@A$, get $\G, x:\sigma \V M : \pi @A$ and $\G \V N:\sigma @ A$.

        Then we can fix $x, \pi$ as $x, \rho$ in the statement correspondingly.

\end{itemize}

\begin{thm}[Preservation of substitution in $\natural$]
    If $\G, x:\sigma \V M:\tau@A$ and $\G \V N:\sigma@A$ in $\lambda^{\text{MD}}$
    then $\natural(M[x \mapsto N])$ = $\natural(M)[x\mapsto\natural(N)]$
\end{thm}

Prove by induction on the type derivation tree of $\G, x:\sigma \V M:\tau@A$.

\begin{thm}[Preservation of $\beta$ reduction in $\natural$]
    If $\G \V M:\tau@A$ and $M \longrightarrow_\beta N$ in $\lambda^{\text{MD}}$ 
    then $\natural(M) \longrightarrow_\beta^+ \natural(N)$.
\end{thm}

Prove by induction on the derivation of $\beta$ reduction.

\begin{itemize}
    \newcommand{\R}{\longrightarrow_{\beta}}
    \item $(\lambda x:\tau.M)\ N \R M[x \mapsto N]$
    
        From the definition of $\natural$, $\natural((\lambda x:\tau.M)\ N)$ = $\lambda x:\natural(\tau).\natural(M)\ \natural(N)$.

        $\lambda x:\natural(\tau).\natural(M)\ \natural(N)$ is a typed term in $\lambda^\to$, we can do $\beta$ reduction from it.\\
        As a result of the reduction, we get $\natural(M)[x\mapsto\natural(N)]$.

        On the otherside, use "Inversion Lemma for Application" to $(\lambda x:\tau.M)\ N$, get $\G, x:\sigma \V M:\tau@A$ and $\G \V N:\sigma@A$.
        From "Preservation of substitution in $\natural$", $\natural(M[x \mapsto N])$ = $\natural(M)[x\mapsto\natural(N)]$.

    \item Otherwise
    
        Use the induction hypothesis.
\end{itemize}

\begin{thm}[Strong Normalization]
    If $\G\V^A t:T$ then there is no infinite sequence of terms $(t_i)_{i\ge1}$ and $t_i \longrightarrow_{\beta, \TBL \TB,\Lambda} t_{i+1}$ for $i\ge 1$
\end{thm}

Prove if there are infinite reductions in $\lambda^{\text{MD}}$ then there are infinite beta reductions in $\lambda^{\text{MD}}$.\\
This is because other reductions reduce the size of term.\\

Now, we can conclude there are no infinite reductions in a typed $\lambda^{\text{MD}}$ term. \\

This is because if there are no infinite reduction in a typed $\lambda^{\text{MD}}$ term $M$,
we can construct a typed term of simply typed lambda calculus $\natural(M)$ from "Preservation of typing in $\natural$".
And $\natural(M)$ has infinite reductions from "Preservation of $\beta$ reduction in $\natural$".\\

But, indeed, $\lambda^\to$ has a property of Strong Normalization, so there is no infinite reductions.

\begin{thm}[Confluence(Church-Rosser Property)]
    Define $M \longrightarrow N$ as $M \longrightarrow_{\beta} N$ or $M\longrightarrow_\blacklozenge N$ or  $M \longrightarrow_{\Lambda} N$.\\
    For any term $M$, if $M \longrightarrow^* N$ and $M \longrightarrow^* L$,
    there exists $O$ that satisfies $N \longrightarrow^* O$ and $L \longrightarrow^* O$.
\end{thm}

\textsc{Proof.}

Because we show the Strong Normalization of $\lambda^{\text{MD}}$, we can use Newman's lemma to prove Church-Rosser property of $\lambda^{\text{MD}}$.
Then, what we must show is Weak Church-Rosser Property now.

When we consider two dirfferent redux in a $\lambda^{\text{MD}}$ term, they can only be disjoint, or one is a part of the other.
In short, they are never overlapped each other.
So, we can reduce one of them after we reduce another.\\

\figheader{Values and Redexes}{}
$A \neq \epsilon$\\
\begin{align*}
    \textrm{Values} && v^\epsilon \in V^\epsilon & ::= \lambda x:\tau.M \mid\ \TB_\alpha v^\alpha \mid \Lambda\alpha.v^\epsilon & \\
                    && v^A \in V^A & ::= x \mid \lambda x:\tau.v^A \mid v^A\ v^A \mid\ \TB_\alpha v^{A\alpha} 
                                           \mid \Lambda\alpha.v^A \mid v^A\ \epsilon &\\
                                    &&& \quad\   \mid\ \TBL_\alpha v^{A'} (\text{if } A'\alpha = A \text{ and } A' \neq \epsilon) & \\
                                    &&& \quad\   \mid \%_\alpha v^{A'} (\text{if } A'\alpha = A) & \\
    \textrm{Redexes} && R^\epsilon & ::= (\lambda x:\tau.M)\ v^\epsilon \mid (\Lambda\alpha.v^\epsilon)\ \epsilon & \\
                     && R^\alpha & ::=\ \TBL_\alpha \TB_\alpha M & \\
\end{align*}

\begin{dfn}[Reduction]
    $ M \longrightarrow M'$ iff \\
    $ M \longrightarrow_\Lambda M' $, $ M \longrightarrow_\blacklozenge M' $ or $ M \longrightarrow_\beta M' $.
\end{dfn}

\begin{thm}[Progress]
    If $x:\tau@\epsilon \notin \G$ and $\G \V M : \tau @ A$ then $ M \in V^A $ or $\exists M'$ such that $M \longrightarrow M'$.
\end{thm}

Prove by induction on the type derivation tree of $\G \V M:\tau@A$.

\begin{itemize}
    \item \TVar
    \begin{itemize}
        \item $ A = \epsilon$
        
            This case is impossible because $x:\tau@\epsilon \notin \G$.
        \item Otherwise
        
            This case is obvious because $x \in V^A$.
    \end{itemize}

    \item \TTBL
    
        The derivation is $\MD{1}$.

        $\MD{1}$ = \infer[\TTBL]
        {\G \V \TBL_\alpha M :\tau @ A\alpha}
        {\ID{\G \V M : \TW_\alpha \tau @ A}}

        There are two cases for the induction hypothesis.

        \begin{itemize}

            \item $ M \in V^A $
            
                \begin{itemize}
                    \item $ A = \epsilon $

                        Use "Inversion Lemma" for all cases of $v^\epsilon$, the case of $ M = \TB_\alpha v^\alpha $ is only reasonable.\\
                        From the definition of $ \longrightarrow $, $\TBL_\alpha \TB_\alpha v^\alpha \longrightarrow v^\alpha$

                    \item Otherwise
                    
                        $ \TBL_\alpha M \in V^{A\alpha}$.
                \end{itemize}
            
            \item $\exists M'$ such that $M \longrightarrow M'$

                From the definition of $ \longrightarrow $, $\TBL_\alpha M \longrightarrow \TBL_\alpha M'$

        \end{itemize}

    \item \TApp
     
        The derivation looks like $\MD{1}$.

        $\MD{1}$ = \infer[\TApp]
        {\G \V M\ N :\tau[x\mapsto N] @ A}
        {\ID{\G \V M : (\Pi x:\sigma.\tau) @ A} \andalso \ID{\G \V N : \sigma @ A}}

        \begin{itemize}
            \item $M \in V^A$ and $N \in V^A$
            
                \begin{itemize}
                    \item $A=\epsilon$
                    
                        $M = \lambda x:\sigma.L$ from the definition of $V^\epsilon$ and Inversion Lemma.\\
                        Then, $\lambda x:\sigma.L\ N \longrightarrow_\beta L[x\mapsto N]$.
                    \item Otherwise
                    
                        $M\ N \in V^A$.
                \end{itemize}
            \item Otherwise
            
                $M\ N \longrightarrow M'\ N$ or $M\ N \longrightarrow M\ N'$.
        \end{itemize}
   
    \item \TIns
 
        The derivation looks like $\MD{1}$.

        $\MD{1}$ = \infer[\TIns]
        {\G \V M\ \epsilon : \tau[\alpha \mapsto \epsilon] @ A}
        {\ID{\G \V M : \forall\alpha.\tau @ A}}

        \begin{itemize}
            \item $ M \in V^A $
            
                \begin{itemize}
                    \item $A=\epsilon$

                        $M = \Lambda\alpha.v^\epsilon$ from the definition of $V^\epsilon$ and Inversion Lemma.\\
                        Then, $\Lambda\alpha.v^\epsilon\ \epsilon \longrightarrow_\Lambda v^\epsilon[x\mapsto \epsilon]$.

                    \item Otherwise
                    
                        $v^A \epsilon \in V^A$.
                \end{itemize}
                    
            \item $\exists M'$ such that $M \longrightarrow M'$
            
                $M\ \epsilon \longrightarrow M'\ \epsilon$
        \end{itemize}

    \item Others
    
        It is obvious from the induction hypothesis.

\end{itemize}

\blue{\huge{It is work in progress from here.}}

\begin{dfn}[\% Powerset of a Term]
    For a term $M$, $M^\%$ is a set of terms.\\
    $M' \in M^\%$ iff you can get $M'$ from $M$ by removing arbitary number $\%$.
\end{dfn}

\begin{thm}[Equality and Reduction]
    $\G \V M \E N : \tau @A$ if and only if\\
    $\exists M' \in M^\%, M' \in M^\%, \exists N' \in N^\%, \exists L$
    such that $\G \V M' : \tau$, $\G \V N' : \tau$, $M' \longrightarrow^* L$ and $N' \longrightarrow^* L$.
\end{thm}

\red{TODO}

\section{ Staged Semantics }

\figheader{Staged Reduction}{}
$A \neq \epsilon$\\
\begin{align*}
    E^A_\epsilon [(\lambda x:\tau.M)\ v^\epsilon] & \longrightarrow_s E^A_\epsilon[M[x\mapsto v^\epsilon]] \\
    E^A_\epsilon [(\Lambda\alpha.v^\epsilon)\ \epsilon] & \longrightarrow_s E^A_\epsilon[v^\epsilon[\alpha\mapsto \epsilon]] \\
    E^A_\alpha [\TBL_\alpha \TB_\alpha v^\alpha] & \longrightarrow_s E^A_\alpha[v^\alpha] \\
\end{align*}

\figheader{Evaluation Context}{}
$A \neq \epsilon$\\
\begin{align*}
    E^\epsilon_B \in ECtx^\epsilon_B & ::= \square\ (\text{if\ } B = \epsilon) \mid E^\epsilon_B\ M \mid v^e\ E^\epsilon_B
                                           \mid \TB_\alpha E^\alpha_B \mid \Lambda\alpha.E^\epsilon_B
                                           \mid E^\epsilon_B\ \epsilon  \\
    E^A_B \in ECtx^A_B & ::= \square\ (\text{if } A = B) \mid \lambda x:\tau.E^A_B \mid E^A_B\ M \mid v^A\ E^A_B
                                           \mid E^\epsilon_B \mid \TB_\alpha E^{A\alpha}_B
                                           \mid \TBL_\alpha E^{A'}_B \ (\text{where } A'\alpha = A) \\
                                           & \quad \mid \Lambda\alpha.E^\epsilon_B
                                           \mid E^A_B\ \epsilon \mid \%_\alpha\ E^{A'}_B \ (\text{where } A'\alpha = A)\\
\end{align*}

\begin{thm}[Unique Decomposition]
    If $x:\tau@\epsilon \notin \G$ and $\G \V M : \tau @ A$ then 1 or 2 is true.
    \begin{enumerate}
        \item $ M \in V^A$
        \item $\exists ! B, E^A_B, R^B$ such that ($B = \epsilon$ or $B = \beta$) and $M = E^A_B[R^B]$.
    \end{enumerate}
\end{thm}

Prove by induction on the type derivation tree of $\G \V M:\tau@A$.

\begin{itemize}
    \item \TVar
    \begin{itemize}
        \item $ A = \epsilon$
        
            This case is impossible because $x:\tau@\epsilon \notin \G$.
        \item Otherwise
        
            This case is obvious because $x \in V^A$.
    \end{itemize}

    \item \TTBL
    \begin{itemize}
        \item $ A = \epsilon$
        
            This case is impossible because the stage of the conclusion of \TTBL\ cannot be $\epsilon$.
        \item $ A = \alpha $
        
            The derivation is $\MD{1}$.

            $\MD{1}$ = \infer[\TTBL]
            {\G \V \TBL_\alpha M :\tau @ \alpha}
            {\ID{\G \V M : \TW_\alpha \tau @ \epsilon}}

            From the induction hypothesis, 1 or 2 is true.
            \begin{enumerate}
                \item $ M \in V^\epsilon$
                \item $\exists ! B, E^\epsilon_B, R^B$ such that ($B = \epsilon$ or $B = \beta$) and $M = E^\epsilon_B[R^B]$.
            \end{enumerate}

            \begin{itemize}
                \item $ M \in V^\epsilon$ is true
                
                Use "Inversion Lemma" for all cases of $v^\epsilon$, the case of $ M = \TB_\alpha v^\alpha $ is only reasonable.
                
                Then, $\TBL_\alpha \TB_\alpha v^\alpha = E^\alpha_\alpha [R^\alpha]$.

                \item $\exists ! B, E^\epsilon_B, R^B$ such that ($B = \epsilon$ or $B = \beta$) and $M = E^\epsilon_B[R^B]$ is true.
                
                \begin{itemize}
                    \item $ M = \TB_\alpha E^\alpha_B[R^B] $
                    \item Otherwise
                \end{itemize}
            \end{itemize}

        \item Otherwise

    \end{itemize}

    \item \TConv
    
        We can use the induction hypothesis directly.

\end{itemize}



% \section{ Deterministic Typechecking }
%
% \figheader{Well-formed kinds}{\rulefbox{\Gamma \vdash K\iskind}}
% \begin{center}
%     \infrule{}{\G\VT *\iskind @A}{\WStar} \andalso
%     \infrule{\G\VT \tau::*@A \andalso \G,x:\tau@A\VT K\iskind @A}{\G\VT(\Pi x:\tau.K)\iskind @A}{\WAbs}\andalso
%     \infrule{\G\VT K\iskind @A}{\G\VT K\iskind @A\alpha}{\WCsp}\\[2mm]
% \end{center}
% 
% \figheader{Kinding}{\rulefbox{\G \VT T::K}}
% \begin{center}
%     \infrule{X::K@A \in \G \andalso \G\VT K\iskind @A}{\G \VT X::K@A}{\KVar} \andalso
%     \infrule{\G\VT \tau :: *@A \andalso \G,x:\tau@A\VT \sigma::J@A}{\G\VT(\Pi x:\tau.\sigma) :: (\Pi x:\tau.J)@A}{\KAbs} \\[2mm]
%     \infrule{\G\VT \sigma:: (\Pi x:\tau.K)@A \andalso \G\VT M:\tau'@A \andalso \G\VT \tau\E\tau' @A}{\G\VT \sigma\ M::K[x\mapsto M]@A}{\KApp} \andalso
%     \infrule{\G\VT \tau::*@A\alpha}{\G\VT\TW_\alpha \tau::*@A}{\KTW}\andalso
%     \infrule{\G\VT \tau::K@A \andalso \alpha\notin\rm{FTV}(\G)\cup\rm{FTV}(A)}{\G\VT\forall\alpha.\tau::K@A}{\KGen} \andalso
%     \infrule{\G\VT \tau::K@A}{\G\VT \tau::K@A\alpha}{\KCsp} \end{center}
% 
% \figheader{Typing}{\rulefbox{\G\VT t:\tau}}
% \begin{center}
%     \infrule{x:\tau@A \in \G \andalso \G\VT \tau::*@A}{\G \VT x:\tau@A}{\TVar} \andalso
%     \infrule{\G\VT \sigma::*@A\andalso\G,x:\sigma@A\VT M:\tau@A}{\G\VT(\lambda (x:\sigma).M):(\Pi (x:\sigma).\tau)@A}{\textsc{T-Abs}} \\[2mm]
%     \infrule{\G\VT M:(\Pi (x:\sigma).\tau)@A \andalso \G\VT N:\sigma'@A \andalso \G\VT \sigma\E\sigma' @A}{\G\VT M\ N : \tau[x\mapsto N]@A}{\textsc{T-App}} \andalso
%     \infrule{\G\VT M:\tau@{A\alpha}}{\G\VT\TB_{\alpha}M:\TW_{\alpha}\tau@A}{\textsc{T-$\TB$}} \andalso
%     \infrule{\G\VT M:\TW_{\alpha}\tau@A}{\G\VT\TBL_{\alpha}M:\tau@{A\alpha}}{\TTBL} \\[2mm]
%     \infrule{\G\VT M:\tau@A \andalso \alpha\notin\rm{FTV}(\G)\cup\rm{FTV}(A)}{\G\VT\Lambda\alpha.M:\forall\alpha.\tau@A}{\textsc{T-Gen}} \andalso
%     \infrule{\G\VT M:\forall\alpha.\tau@A}{\G\VT M\ \epsilon:\tau[\alpha \mapsto \epsilon]@A}{\textsc{T-Ins}} \andalso
%     \infrule{\G\VT M:\tau@A}{\G\VT \%_\alpha M:\tau@{A\alpha}}{\textsc{T-Csp}} \andalso
% \end{center}
% 
% \figheader{Kind Equivalence}{\rulefbox{\G\VT K\E J@A}}
% \begin{center}
%     \infrule{\G\VT \tau \E \sigma :: *@A \andalso \G,x:\tau@A \VT K \E J@A}{\G\VT\Pi x:\tau.K \E \Pi x:\sigma.J@A}{\QKAbs} \andalso
%     \infrule{\G\VT K \E J@A}{\G\VT K \E J@{A\alpha}}{\textsc{QK-Csp}} \\[4mm]
% \end{center}
% 
% \figheader{Type Equivalence}{\rulefbox{\G\VT S\E T @A}}
% \begin{center}
%     \infrule{\G\VT \tau \E \sigma @A \andalso \G,x:\tau@A \VT \rho \E \pi @A}{\G\VT\Pi x:\tau.\rho \E \Pi x:\sigma.\pi @A}{\QTAbs} \andalso
%     \infrule{\G\VT \tau \E \sigma @A \andalso \G\VT M \E N @A}{\G\VT \tau\ M \E \sigma\ N @A}{\QTApp} \\[2mm]
%     \infrule{\G\VT \tau \E \sigma @{A\alpha}}{\G\VT \TW_{\alpha} \tau \E \TW_{\alpha} \sigma @A}{\textsc{QT-$\TW$}}\andalso
%     \infrule{\G\VT \tau \E \sigma @A \andalso \alpha\notin\rm{FTV}(\G)\cup\rm{FTV}(A)}{\G\VT \forall\alpha.\tau \E  \forall\alpha.\sigma @A}{\textsc{QT-Gen}} \andalso
%     \infrule{\G\VT \tau \E \sigma @A}{\G\VT \tau \E \sigma @{A\alpha}}{\textsc{QT-Csp}} \\[4mm]
% \end{center}
% 
% \figheader{Term Equivalence}{\rulefbox{\G\VT M\E N : \tau @A}}
% \begin{center}
%     Demands from syntax rules\\[2mm]
%     \infrule{\G\VT \tau \E \sigma :: *@A \andalso \G,x:\tau@A \VT M \E N : \rho @A}{\G\VT\lambda x:\tau.M \E \lambda x:\sigma.N : (\Pi x:\tau.\rho)@A}{\QAbs} \andalso
%     \infrule{\G\VT M \E L : (\Pi x:\sigma.\tau)@A \andalso \G\VT N \E O : \sigma@A}{\G\VT M\ N \E L\ O : \tau[x \mapsto N]@A}{\QApp} \\[2mm]
%     \infrule{\G\VT M \E N : \tau@{A\alpha}}{\G\VT \TB_\alpha M \E \TB_\alpha N : \TW_\alpha \tau@A}{\QTB} \andalso
%     \infrule{\G\VT M \E N : \TW_\alpha \tau@A}{\G\VT \TBL_\alpha M \E \TBL_\alpha N : \tau@{A\alpha}}{\QTBL} \\[2mm]
%     \infrule{\G\VT M\E N : \tau@A \andalso \alpha \notin \FTV(\G)\cup\FTV(A)}{\G\VT \Lambda\alpha.M \E \Lambda\alpha.N : \forall\alpha.\tau@A}{\QGen} \andalso
%     \infrule{\G\VT M \E N:\forall\alpha.\tau@A}{\G\VT M\ \epsilon \E N\ \epsilon : \tau[\alpha \mapsto \epsilon]@A}{\QIns}\andalso
%     \infrule{\G\VT M \E N : \tau @A}{\G\VT\%_\alpha M \E \%_\alpha N : \tau@{A\alpha}}{\QCsp} \\[4mm]
%     Demands from equivalence relationship\\[2mm]
%     \infrule{\G\VT M:\tau@A}{\G\VT M\E M : \tau@A}{\QRefl} \andalso
%     \infrule{\G\VT M\E N : \tau@A}{\G\VT N\E M : \tau@A}{\QSym} \andalso
%     \infrule{\G\VT M\E N : \tau@A \andalso \G\VT N\E L : \tau@A}{\G\VT M\E L : \tau@A}{\QTrans} \\[4mm]
%     Demands from reduction rule\\[2mm]
%     \infrule{\G,x:\sigma@A\VT M:\tau@A \andalso \G\VT N:\sigma@A}{\G\VT(\lambda x:\sigma.M)\ N\E M[x\mapsto N] : \tau[x \mapsto N]@A}{\QBeta} \andalso
%     \infrule{\G\VT M:(\Pi x:\sigma.\tau)@A \andalso x\notin \text{FV}(M)}{\G\VT(\lambda x:\sigma.M\ x)\E M: (\Pi x:\sigma.\tau)@A}{\QEta} \\[2mm]
%     \infrule{\G\VT M \E N : \tau@A}{\G\VT \TBL_\alpha(\TB_\alpha M) \E N : \tau @A}{\QTBLTB} \andalso
%     \infrule{\G\VT (\Lambda\alpha.M) : \forall\alpha.\tau@A}{\G\VT (\Lambda\alpha.M)\ \epsilon \E M[\alpha \mapsto \epsilon] : \tau[\alpha \mapsto \epsilon]@A}{\QLambda} \\[2mm]
%     \infrule{\G\VT M:\tau@{A\alpha} \andalso \G\VT M:\tau@A}{\G\VT\%_\alpha M \E M : \tau@{A\alpha}}{\QPercent} \andalso
% \end{center}

% \figheader{Well-formed kinds}{\rulefbox{\Gamma \vdash K\iskind}}
% \begin{center}
%     \infrule{}{\G\VT*\iskind @A}{\WStar} \andalso
%     \infrule{\G\VT \tau::*@A \andalso \G,x:\tau@A\VT K\iskind @A}{\G\VT(\Pi x:\tau.K)\iskind @A}{\WAbs}\andalso
%     \infrule{\G\VT K\iskind @A}{\G\VT K\iskind @A\alpha}{\WCsp}\\[2mm]
% \end{center}
% 
% \figheader{Kinding}{\rulefbox{\G \VT T::K}}
% \begin{center}
%     \infrule{X::K@A \in \G \andalso \G\VT K\iskind @A}{\G \VT X::K@A}{\KVar} \andalso
%     \infrule{\G\VT \tau :: *@A \andalso \G,x:\tau@A\VT \sigma::J@A}{\G\VT(\Pi x:\tau.\sigma) :: (\Pi x:\tau.J)@A}{\KAbs} \\[2mm]
%     \infrule{\G\VT \sigma:: (\Pi x:\tau.K)@A \andalso \G\VT M:\tau@A}{\G\VT \sigma\ M::K[x\mapsto M]@A}{\KApp} \andalso
%     \infrule{\G\VT \tau::K@A \andalso \G\VT K\equiv J@A}{\G\VT \tau::J@A}{\KConv} \\[2mm]
%     \infrule{\G\VT \tau::*@A\alpha}{\G\VT\TW_\alpha \tau::*@A}{\KTW}\andalso
%     \infrule{\G\VT \tau::K@A \andalso \alpha\notin\rm{FTV}(\G)\cup\rm{FTV}(A)}{\G\VT\forall\alpha.\tau::K@A}{\KGen} \andalso
%     \infrule{\G\VT \tau::K@A}{\G\VT \tau::K@A\alpha}{\KCsp}
% \end{center}
% 
% \figheader{Typing}{\rulefbox{\G\VT t:\tau}}
% \begin{center}
%     \infrule{x:\tau@A \in \G \andalso \G\VT \tau::*@A}{\G \VT x:\tau@A}{\TVar} \andalso
%     \infrule{\G\VT \sigma::*@A\andalso\G,x:\sigma@A\VT M:\tau@A}{\G\VT(\lambda (x:\sigma).M):(\Pi (x:\sigma).\tau)@A}{\textsc{T-Abs}} \\[2mm]
%     \infrule{\G\VT M:(\Pi (x:\sigma).\tau)@A \andalso \G\VT N:\sigma@A}{\G\VT M\ N : \tau[x\mapsto N]@A}{\textsc{T-App}} \andalso
%     \infrule{\G\VT M:\tau@A \andalso \G\VT \tau\equiv \sigma :: K@A}{\G\VT M:\sigma@A}{\textsc{T-Conv}} \\[2mm]
%     \infrule{\G\VT M:\tau@{A\alpha}}{\G\VT\TB_{\alpha}M:\TW_{\alpha}\tau@A}{\textsc{T-$\TB$}} \andalso
%     \infrule{\G\VT M:\TW_{\alpha}\tau@A}{\G\VT\TBL_{\alpha}M:\tau@{A\alpha}}{\TTBL} \\[2mm]
%     \infrule{\G\VT M:\tau@A \andalso \alpha\notin\rm{FTV}(\G)\cup\rm{FTV}(A)}{\G\VT\Lambda\alpha.M:\forall\alpha.\tau@A}{\textsc{T-Gen}} \andalso
%     \infrule{\G\VT M:\forall\alpha.\tau@A}{\G\VT M\ \epsilon:\tau[\alpha \mapsto \epsilon]@A}{\textsc{T-Ins}} \andalso
%     \infrule{\G\VT M:\tau@A}{\G\VT \%_\alpha M:\tau@{A\alpha}}{\textsc{T-Csp}} \andalso
% \end{center}
% 
% \figheader{Kind Equivalence}{\rulefbox{\G\VT K\E J@A}}
% \begin{center}
%     \infrule{\G\VT \tau \E \sigma :: *@A \andalso \G,x:\tau@A \VT K \E J@A}{\G\VT\Pi x:\tau.K \E \Pi x:\sigma.J@A}{\QKAbs} \andalso
%     \infrule{\G\VT K \E J@A}{\G\VT K \E J@{A\alpha}}{\textsc{QK-Csp}} \\[2mm]
%     \infrule{\G\VT K \iskind @A}{\G\VT K\E K@A}{\textsc{QK-Refl}} \andalso
%     % 簡約規則の要請\\[2mm]
% \end{center}
% 
% \figheader{Type Equivalence}{\rulefbox{\G\VT S\E T :: K @A}}
% \begin{center}
%     \infrule{\G\VT \tau \E \sigma :: *@A \andalso \G,x:\tau@A \VT \rho \E \pi :: *@A}{\G\VT\Pi x:\tau.\rho \E \Pi x:\sigma.\pi :: *@A}{\QTAbs} \andalso
%     \infrule{\G\VT \tau \E \sigma :: (\Pi x:\rho.K)@A \andalso \G\VT M \E N : \rho @A}{\G\VT \tau\ M \E \sigma\ N :: K[x \mapsto M]@A}{\QTApp} \\[2mm]
%     \infrule{\G\VT \tau \E \sigma :: *@{A\alpha}}{\G\VT \TW_{\alpha} \tau \E \TW_{\alpha} \sigma :: *@A}{\textsc{QT-$\TW$}}\andalso
%     \infrule{\G\VT \tau \E \sigma :: *@A \andalso \alpha\notin\rm{FTV}(\G)\cup\rm{FTV}(A)}{\G\VT \forall\alpha.\tau \E  \forall\alpha.\sigma :: *@A}{\textsc{QT-Gen}} \andalso
%     \infrule{\G\VT \tau \E \sigma :: K@A}{\G\VT \tau \E \sigma :: K@{A\alpha}}{\textsc{QT-Csp}} \\[2mm]
%     \infrule{\G\VT \tau::K@A}{\G\VT \tau\E\tau :: K@A}{\textsc{QT-Refl}} 
% \end{center}
% 
% \figheader{Term Equivalence}{\rulefbox{\G\VT M\E N : \tau @A}}
% \begin{center}
%     \infrule{\G\VT \tau \E \sigma :: *@A \andalso \G,x:\tau@A \VT M \E N : \rho @A}{\G\VT\lambda x:\tau.M \E \lambda x:\sigma.N : (\Pi x:\tau.\rho)@A}{\QAbs} \andalso
%     \infrule{\G\VT M \E L : (\Pi x:\sigma.\tau)@A \andalso \G\VT N \E O : \sigma@A}{\G\VT M\ N \E L\ O : \tau[x \mapsto N]@A}{\QApp} \\[2mm]
%     \infrule{\G\VT M \E N : \tau@{A\alpha}}{\G\VT \TB_\alpha M \E \TB_\alpha N : \TW_\alpha \tau@A}{\QTB} \andalso
%     \infrule{\G\VT M \E N : \TW_\alpha \tau@A}{\G\VT \TBL_\alpha M \E \TBL_\alpha N : \tau@{A\alpha}}{\QTBL} \\[2mm]
%     \infrule{\G\VT M\E N : \tau@A \andalso \alpha \notin \FTV(\G)\cup\FTV(A)}{\G\VT \Lambda\alpha.M \E \Lambda\alpha.N : \forall\alpha.\tau@A}{\QGen} \andalso
%     \infrule{\G\VT M \E N:\forall\alpha.\tau@A}{\G\VT M\ \epsilon \E N\ \epsilon : \tau[\alpha \mapsto \epsilon]@A}{\QIns}\andalso
%     \infrule{\G\VT M \E N : \tau @A}{\G\VT\%_\alpha M \E \%_\alpha N : \tau@{A\alpha}}{\QCsp} \\[2mm]
%     \infrule{\G\VT M:\tau@A}{\G\VT M\E M : \tau@A}{\QRefl} \\[2mm]
%     \infrule{\G,x:\sigma@A\VT M:\tau@A \andalso \G\VT N:\sigma@A}{\G\VT(\lambda x:\sigma.M)\ N\E M[x\mapsto N] : \tau[x \mapsto N]@A}{\QBeta} \andalso
%     \infrule{\G,x:\sigma@A\VT M:\tau@A \andalso \G\VT N:\sigma@A}{\G\VT M[x\mapsto N] \E (\lambda x:\sigma.M)\ N : \tau[x \mapsto N]@A}{\QBeta T} \\[2mm]
%     \infrule{\G\VT M:(\Pi x:\sigma.\tau)@A \andalso x\notin \text{FV}(M)}{\G\VT(\lambda x:\sigma.M\ x)\E M: (\Pi x:\sigma.\tau)@A}{\QEta} \andalso
%     \infrule{\G\VT M:(\Pi x:\sigma.\tau)@A \andalso x\notin \text{FV}(M)}{\G\VT M \E (\lambda x:\sigma.M\ x) @A}{\QEta T} \\[2mm]
%     \infrule{\G\VT M \E N : \tau@A}{\G\VT \TBL_\alpha(\TB_\alpha M) \E N : \tau @A}{\QTBLTB} \andalso
%     \infrule{\G\VT M \E N : \tau@A}{\G\VT N \E \TBL_\alpha(\TB_\alpha M) : \tau @A}{\QTBLTB T} \\[2mm]
%     \infrule{\G\VT (\Lambda\alpha.M) : \forall\alpha.\tau@A}{\G\VT (\Lambda\alpha.M)\ \epsilon \E M[\alpha \mapsto \epsilon] : \tau[\alpha \mapsto \epsilon]@A}{\QLambda} \andalso
%     \infrule{\G\VT (\Lambda\alpha.M) : \forall\alpha.\tau@A}{\G\VT M[\alpha \mapsto \epsilon] \E (\Lambda\alpha.M)\ \epsilon : \tau[\alpha \mapsto \epsilon]@A}{\QLambda} \\[2mm]
%     \infrule{\G\VT M:\tau@{A\alpha} \andalso \G\VT M:\tau@A}{\G\VT\%_\alpha M \E M : \tau@{A\alpha}}{\QPercent} \\[2mm]
%     \infrule{\G\VT M:\tau@{A\alpha} \andalso \G\VT M:\tau@A}{\G\VT M \E \%_\alpha M : \tau@{A\alpha}}{\QPercent}
% \end{center}

\end{document}
